@page "/login"
@rendermode InteractiveServer
@using System.Security.Cryptography
@using System.Text
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using QuanLyKho.Data
@using QuanLyKho.Models
@using QuanLyKho.Auth

@inject AppDbContext DbContext
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<style>
    .login-bg {
        /* Gradient xanh dương nhẹ */
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        min-height: 100vh;
    }

    .card-login {
        border: none;
        border-radius: 1rem;
        /* Bo góc mềm mại */
    }

    .btn-login {
        background-color: #1976d2;
        /* Xanh đậm hơn chút để nổi bật */
        border: none;
        padding: 12px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-login:hover {
        background-color: #1565c0;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(25, 118, 210, 0.2);
    }

    .form-control:focus {
        border-color: #90caf9;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }

    .icon-bg {
        background-color: #e3f2fd;
        color: #1976d2;
    }
</style>

<div class="container-fluid login-bg d-flex align-items-center justify-content-center">
    <div class="card card-login shadow-lg p-4" style="max-width: 420px; width: 100%;">
        <div class="card-body">

            <div class="text-center mb-4">
                <img src="https://cdn-icons-png.flaticon.com/512/9131/9131529.png" alt="Avatar"
                    class="rounded-circle border" width="40" height="40" />
                <h3 class="fw-bold text-primary">Đăng Nhập</h3>
                <p class="text-muted small">Chào mừng bạn quay trở lại hệ thống</p>
            </div>

            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="floatingInputUser" placeholder="Nhập tên đăng nhập"
                    @bind="username" />
                <label for="floatingInputUser" class="text-secondary">
                    <i class="bi bi-person me-2"></i>Tên đăng nhập
                </label>
            </div>

            <div class="form-floating mb-4">
                <input type="password" class="form-control" id="floatingInputPass" placeholder="Nhập mật khẩu"
                    @bind="password" />
                <label for="floatingInputPass" class="text-secondary">
                    <i class="bi bi-lock me-2"></i>Mật khẩu
                </label>
            </div>
            <button class="btn btn-primary w-100 btn-login text-white mb-3 rounded-pill" @onclick="HandleLogin">
                Đăng Nhập
            </button>

            <div class="text-center">
                <span class="text-muted">Chưa có tài khoản?</span>
                <a href="/register" class="text-primary text-decoration-none fw-bold ms-1">Đăng ký ngay</a>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-4 d-flex align-items-center shadow-sm border-0" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                    <div>@errorMessage</div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    // --- GIỮ NGUYÊN 100% LOGIC CŨ CỦA BẠN ---

    private string username = "";
    private string password = "";
    private string errorMessage = "";

    private async Task HandleLogin()
    {
        errorMessage = "";

        if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "Vui lòng nhập đầy đủ Tài khoản và Mật khẩu!";
            return;
        }

        try
        {
            // 1. Mã hóa pass người dùng nhập để so sánh
            string passwordHash = GetMD5Hash(password);

            // 2. Kiểm tra trong Database
            var user = await DbContext.Users
            .AsNoTracking()
            .FirstOrDefaultAsync(u => u.Username == username && u.Password_hash == passwordHash);

            // Nếu không tìm thấy hoặc sai pass
            if (user == null)
            {
                errorMessage = "Sai tài khoản hoặc mật khẩu!";
                return;
            }

            if (user.Status != "Active")
            {
                errorMessage = "Tài khoản đang bị khóa!";
                return;
            }

            // 3. Cập nhật trạng thái đăng nhập (Ghi nhớ User)
            var customAuthStateProvider = (CustomAuthenticationStateProvider)AuthStateProvider;
            await customAuthStateProvider.UpdateAuthenticationState(new UserSession
            {
                UserName = user.Username,
                Role = user.Role
            });

            // 4. KIỂM TRA ROLE ĐỂ ĐIỀU HƯỚNG
            // Chuyển role về chữ thường và cắt khoảng trắng để so sánh chính xác
            string role = user.Role?.Trim().ToLower() ?? "";

            // Logic: Admin(1) -> Dashboard, Staff(0) -> Sale
            // Code này hỗ trợ cả nếu bạn lưu trong DB là chữ "admin" hoặc số "1"
            if (role == "admin" || role == "1")
            {
                Nav.NavigateTo("/admin/dashboard", forceLoad: false);
            }
            else if (role == "staff" || role == "0")
            {
                Nav.NavigateTo("/staff/sales", forceLoad: false);
            }
            else
            {
                // Role lạ hoặc chưa phân quyền -> Về trang chủ
                Nav.NavigateTo("/", forceLoad: false);
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Lỗi kết nối: " + ex.Message;
        }
    }

    private string GetMD5Hash(string input)
    {
        using (MD5 md5 = MD5.Create())
        {
            byte[] inputBytes = Encoding.ASCII.GetBytes(input);
            byte[] hashBytes = md5.ComputeHash(inputBytes);
            return Convert.ToHexString(hashBytes);
        }
    }
}