@page "/admin/user-management"
@layout QuanLyKho.Components.Layout.AdminLayout
@using QuanLyKho.Data
@using QuanLyKho.Models
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db
@rendermode InteractiveServer

<PageTitle>Qu·∫£n l√Ω t√†i kho·∫£n</PageTitle>

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold mb-0 text-gray-800">Qu·∫£n l√Ω T√†i kho·∫£n</h2>
        </div>
        <button class="btn btn-primary shadow-sm fw-bold" @onclick="OpenCreateModal">
            <i class="bi bi-person-plus-fill"></i> Th√™m t√†i kho·∫£n
        </button>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4">Username</th>
                    <th>Email</th>
                    <th>Vai tr√≤</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th class="text-end pe-4">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in users)
                {
                    <tr>
                        <td class="ps-4 fw-bold">@user.Username</td>
                        <td>@user.Email</td>
                        <td>
                            @if (user.Role == "Admin") 
                            { 
                                <span class="badge bg-danger">Admin</span> 
                            }
                            else 
                            { 
                                <span class="badge bg-primary">Staff</span> 
                            }
                        </td>
                        <td>
                            <span class="badge @(user.Status == "Active" ? "bg-success" : "bg-secondary")">@user.Status</span>
                        </td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => OpenEditModal(user)">‚úèÔ∏è S·ª≠a</button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDelete(user)">üóëÔ∏è X√≥a</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (IsShowModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(EditingUser.User_id == 0 ? "Th√™m m·ªõi" : "C·∫≠p nh·∫≠t")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Username</label>
                        <input class="form-control" @bind="EditingUser.Username" disabled="@(EditingUser.User_id > 0)" />
                    </div>
                    <div class="mb-3">
                        <label>Email</label>
                        <input class="form-control" @bind="EditingUser.Email" />
                    </div>
                    <div class="mb-3">
                        <label>S·ªë ƒëi·ªán tho·∫°i</label>
                        <input class="form-control" @bind="EditingUser.Phone" />
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label>Vai tr√≤</label>
                            <select class="form-control" @bind="EditingUser.Role">
                                <option value="Staff">Nh√¢n vi√™n (Staff)</option>
                                <option value="Admin">Qu·∫£n tr·ªã (Admin)</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label>Tr·∫°ng th√°i</label>
                            <select class="form-control" @bind="EditingUser.Status">
                                <option value="Active">Active</option>
                                <option value="Locked">Locked</option>
                            </select>
                        </div>
                    </div>
                    @if(EditingUser.User_id == 0)
                    {
                         <div class="text-muted small mt-2 text-danger">* M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh: 123</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">H·ªßy</button>
                    <button class="btn btn-primary" @onclick="SaveUser">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool IsShowModal = false;
    private User EditingUser = new User { Role = "Staff", Status = "Active" }; 
    private List<User> users = new();

    protected override void OnInitialized() => LoadData();
    private void LoadData() => users = Db.Users.OrderByDescending(u => u.User_id).ToList();

    private void OpenCreateModal() { 
        EditingUser = new User { Role = "Staff", Status = "Active", CreateAt = DateTime.Now }; 
        IsShowModal = true; 
    }
    
    private void OpenEditModal(User u) {
        EditingUser = new User { 
            User_id = u.User_id, 
            Username = u.Username, 
            Email = u.Email, 
            Phone = u.Phone, 
            Role = u.Role, 
            Status = u.Status, 
            CreateAt = u.CreateAt, 
            Password_hash = u.Password_hash 
        };
        IsShowModal = true;
    }

    private void SaveUser() {
        if (EditingUser.User_id == 0) {

            if(string.IsNullOrEmpty(EditingUser.Password_hash)) EditingUser.Password_hash = "123";
            Db.Users.Add(EditingUser);
        } else {
            var dbUser = Db.Users.Find(EditingUser.User_id);
            if(dbUser != null) { 
                dbUser.Email = EditingUser.Email; 
                dbUser.Phone = EditingUser.Phone; 
                dbUser.Role = EditingUser.Role; 
                dbUser.Status = EditingUser.Status; 
            }
        }
        Db.SaveChanges(); 
        IsShowModal = false; 
        LoadData();
    }
    
    private void ConfirmDelete(User u) {
        var dbUser = Db.Users.Find(u.User_id);
        if(dbUser != null) { 
            Db.Users.Remove(dbUser); 
            Db.SaveChanges(); 
            LoadData(); 
        }
    }
    private void CloseModal() => IsShowModal = false;
}