@page "/admin/user-management"
@using System.Globalization
@layout AdminLayout
@using QuanLyKho.Components.Layout
@inject NavigationManager Nav
@rendermode InteractiveServer
@using QuanLyKho.Data
@inject AppDbContext Db

<div class="container-fluid px-4" @onclick="CloseDropdown">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold mb-0 text-gray-800">Qu·∫£n l√Ω T√†i kho·∫£n</h2>
            <p class="text-muted">Ki·ªÉm so√°t nh√¢n vi√™n & ph√¢n quy·ªÅn h·ªá th·ªëng</p>
        </div>
    </div>

    @* Thanh t√¨m ki·∫øm *@
    <div class="card border-0 shadow-sm mb-4" style="overflow: visible;" @onclick:stopPropagation>
        <div class="card-body p-2 position-relative">
            <div class="input-group border-0">
                <span class="input-group-text bg-white border-0 text-muted"><i class="bi bi-search"></i></span>
                <input class="form-control border-0 shadow-none" placeholder="T√¨m ki·∫øm theo t√™n, email ho·∫∑c vai tr√≤..."
                       @bind="SearchTerm" @bind:event="oninput" @onfocus="OpenDropdown" @onclick="OpenDropdown" />
            </div>

            @* Dropdown G·ª£i √Ω *@
            @if (showDropdown && FilteredUsers.Any())
            {
                <div class="dropdown-menu show w-100 shadow mt-1"
                     style="max-height: 300px; overflow-y: auto; position: absolute; z-index: 1000; top: 100%; left: 0;">

                    @foreach (var user in FilteredUsers.Take(displayLimit))
                    {
                        <button class="dropdown-item border-bottom py-2" @onclick="() => OpenEditModal(user)">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">@user.Username</div>
                                    <small class="text-muted">@user.Email</small>
                                </div>

                                @* Badge hi·ªÉn th·ªã trong t√¨m ki·∫øm *@
                                @if (user.Role == "Admin")
                                {
                                    <span class="badge bg-danger">Admin</span>
                                }
                                else if (user.Role == "Staff")
                                {
                                    <span class="badge bg-primary">Staff</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@user.Role</span>
                                }
                            </div>
                        </button>
                    }

                    @if (FilteredUsers.Count() > displayLimit)
                    {
                        <button class="dropdown-item text-center text-primary fw-bold py-2" @onclick="LoadMoreUsers">
                            <small>‚ñº Hi·ªÉn th·ªã th√™m k·∫øt qu·∫£...</small>
                        </button>
                    }
                </div>
            }
        </div>
    </div>

    @* B·∫£ng danh s√°ch User *@
    <div class="card border-0 shadow-sm">
        <div class="table-responsive" style="height: calc(100vh - 300px); overflow-y: auto;">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light sticky-top" style="z-index: 10;">
                    <tr class="text-secondary small fw-bold text-uppercase">
                        <th class="ps-4 py-3 bg-light">ID</th>
                        <th class="bg-light">T√™n ƒëƒÉng nh·∫≠p</th>
                        <th class="bg-light">Email / SƒêT</th>
                        <th class="text-center bg-light">Vai tr√≤</th>
                        <th class="text-center bg-light">Tr·∫°ng th√°i</th>
                        <th class="bg-light">Ng√†y t·∫°o</th>
                        <th class="text-end pe-4 bg-light">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @if (FilteredUsers.Any())
                    {
                        @foreach (var user in FilteredUsers)
                        {
                            <tr @key="user.User_id">
                                <td class="ps-4 text-muted fw-bold">#@user.User_id</td>
                                <td>
                                    <div class="fw-bold text-dark">@user.Username</div>
                                </td>
                                <td>
                                    <div class="text-dark">@user.Email</div>
                                    <small class="text-muted">@user.Phone</small>
                                </td>
                                <td class="text-center">
                                    @if (user.Role == "Admin")
                                    {
                                        <span class="badge bg-danger-subtle text-danger border border-danger rounded-pill px-3">Admin</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-primary-subtle text-primary border border-primary rounded-pill px-3">Staff</span>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (user.Status == "Active")
                                    {
                                        <span class="badge bg-success-subtle text-success border border-success px-2">Ho·∫°t ƒë·ªông</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary-subtle text-secondary border border-secondary px-2">ƒê√£ kh√≥a</span>
                                    }
                                </td>
                                <td class="text-muted small">
                                    @user.CreateAt.ToString("dd/MM/yyyy")
                                </td>

                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-light text-primary me-2" title="S·ª≠a"
                                            @onclick="() => OpenEditModal(user)">
                                        ‚úèÔ∏è
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light text-danger" title="X√≥a"
                                            @onclick="() => ConfirmDelete(user)">
                                        üóëÔ∏è
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                <i class="bi bi-person-x fs-1 opacity-50"></i>
                                <div class="mt-2">Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n n√†o</div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@* Modal Th√™m/S·ª≠a *@
@if (IsShowModal)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5);z-index:1050">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="fw-bold mb-0">@(EditingUser.User_id == 0 ? "Th√™m t√†i kho·∫£n m·ªõi" : "Ch·ªânh s·ª≠a t√†i kho·∫£n")</h5>
                    <button class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">T√™n ƒëƒÉng nh·∫≠p</label>
                        <input class="form-control" @bind="EditingUser.Username" placeholder="Nh·∫≠p username..." />
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <input type="email" class="form-control" @bind="EditingUser.Email"
                                   placeholder="name@example.com" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input class="form-control" @bind="EditingUser.Phone" placeholder="09xxxxxxxx" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Vai tr√≤</label>
                            @* CH·ªà C√íN ADMIN V√Ä STAFF *@
                            <select class="form-select" @bind="EditingUser.Role">
                                <option value="Staff">Staff (Nh√¢n vi√™n)</option>
                                <option value="Admin">Admin (Qu·∫£n tr·ªã)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Tr·∫°ng th√°i</label>
                            <select class="form-select" @bind="EditingUser.Status">
                                <option value="Active">Ho·∫°t ƒë·ªông</option>
                                <option value="Locked">ƒê√£ kh√≥a</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">H·ªßy</button>
                    <button class="btn btn-primary" @onclick="SaveUser">L∆∞u th√¥ng tin</button>
                </div>
            </div>
        </div>
    </div>
}

@* Modal X√≥a *@
@if (ShowDeleteConfirm)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5);z-index:1060">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-body text-center p-4">
                    <div class="text-danger mb-3">
                        <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="fw-bold mb-2">X√°c nh·∫≠n x√≥a t√†i kho·∫£n?</h5>
                    <p class="text-muted mb-4">
                        H√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn user <strong>@DeletingUser?.Username</strong>.
                    </p>
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-secondary px-4" @onclick="() => ShowDeleteConfirm = false">H·ªßy</button>
                        <button class="btn btn-danger px-4" @onclick="DeleteUser">X√≥a ngay</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string SearchTerm = "";
    private bool IsShowModal;
    private bool ShowDeleteConfirm;

    private bool showDropdown = false;
    private int displayLimit = 10;

    private User EditingUser = new User { Role = "Staff", Status = "Active" };
    private User? DeletingUser;

    private List<User> users = new();

    protected override void OnInitialized()
    {
        LoadData();
    }

    private void LoadData()
    {
        users = Db.Users.OrderByDescending(u => u.User_id).ToList();
    }

    private void OpenDropdown()
    {
        showDropdown = true;
        displayLimit = 10;
    }

    private void CloseDropdown()
    {
        Task.Delay(200).ContinueWith(_ => InvokeAsync(() => { showDropdown = false; StateHasChanged(); }));
    }

    private void LoadMoreUsers()
    {
        displayLimit += 10;
    }

    private List<User> FilteredUsers => users
    .Where(u => string.IsNullOrWhiteSpace(SearchTerm) ||
    u.Username.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
    u.Email.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
    u.Role.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase))
    .ToList();


    private void OpenEditModal(User u)
    {
        EditingUser = new User
        {
            User_id = u.User_id,
            Username = u.Username,
            Email = u.Email,
            Phone = u.Phone,
            Role = u.Role,
            Status = u.Status,
            CreateAt = u.CreateAt,
            Password_hash = u.Password_hash
        };
        IsShowModal = true;
        showDropdown = false;
    }

    private void SaveUser()
    {
        if (EditingUser.User_id == 0)
        {
            EditingUser.CreateAt = DateTime.Now;
            if (string.IsNullOrEmpty(EditingUser.Password_hash))
                EditingUser.Password_hash = "123";

            Db.Users.Add(EditingUser);
        }
        else
        {
            var userInDb = Db.Users.Find(EditingUser.User_id);
            if (userInDb != null)
            {
                userInDb.Username = EditingUser.Username;
                userInDb.Email = EditingUser.Email;
                userInDb.Phone = EditingUser.Phone;
                userInDb.Role = EditingUser.Role;
                userInDb.Status = EditingUser.Status;
            }
        }

        Db.SaveChanges();
        IsShowModal = false;
        LoadData();
    }

    private void ConfirmDelete(User u)
    {
        DeletingUser = u;
        ShowDeleteConfirm = true;
        showDropdown = false;
    }

    private void DeleteUser()
    {
        if (DeletingUser != null)
        {
            var userInDb = Db.Users.Find(DeletingUser.User_id);
            if (userInDb != null)
            {
                Db.Users.Remove(userInDb);
                Db.SaveChanges();
            }
        }
        ShowDeleteConfirm = false;
        LoadData();
    }

    private void CloseModal() => IsShowModal = false;
}