@page "/admin/import"
@layout AdminLayout
@rendermode InteractiveServer
@using QuanLyKho.Data
@inject AppDbContext _context
@inject NavigationManager Nav

<PageTitle>Nhập kho</PageTitle>

<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Nhập Kho (Admin)</h1>

    @if (successMessage != null)
    {
        <div class="alert alert-success">@successMessage</div>
    }
    @if (errorMessage != null)
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Thông tin nhập kho</h6>
                </div>

                <div class="card-body">

                    <!-- CHỌN HÃNG -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Chọn hãng</label>
                        <select class="form-control" @onchange="OnBrandChanged">
                            <option value="">-- Tất cả hãng --</option>
                            @foreach (var b in brands)
                            {
                                <option value="@b">@b</option>
                            }
                        </select>
                    </div>

                    <!-- CHỌN SẢN PHẨM -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Chọn sản phẩm</label>
                        <select class="form-control" @onchange="OnProductChanged">
                            <option value="">-- Chọn sản phẩm --</option>
                            @foreach (var p in filteredProducts)
                            {
                                <option value="@p.Id">@p.Name (@p.SKU)</option>
                            }
                        </select>
                    </div>

                    @if (selectedProduct != null)
                    {
                        <div class="border rounded p-3 mb-3 bg-light">
                            <div class="row">
                                <div class="col-md-4">
                                    <img src="@selectedProduct.ImageUrl" class="img-fluid rounded" />
                                </div>
                                <div class="col-md-8">
                                    <p><b>Tên:</b> @selectedProduct.Name</p>
                                    <p><b>SKU:</b> @selectedProduct.SKU</p>
                                    <p><b>Hãng:</b> @selectedProduct.Brand</p>
                                    <p><b>Tồn kho hiện tại:</b> @selectedProduct.Stock</p>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label fw-bold">Số lượng nhập</label>
                        <input type="number" class="form-control" @bind="soLuongNhap" min="1" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Ghi chú</label>
                        <textarea class="form-control" rows="3" @bind="ghiChu"></textarea>
                    </div>

                    <button class="btn btn-success" @onclick="NhapKho">Xác nhận nhập kho</button>
                </div>
            </div>
        </div>

        <!-- TÓM TẮT -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h6 class="m-0">Phiếu nhập</h6>
                </div>
                <div class="card-body">
                    @if (selectedProduct != null)
                    {
                        <p><b>Sản phẩm:</b> @selectedProduct.Name</p>
                        <p><b>Hãng:</b> @selectedProduct.Brand</p>
                        <p><b>Số lượng nhập:</b> @soLuongNhap</p>
                        <p><b>Tồn kho sau nhập:</b> @(selectedProduct.Stock + soLuongNhap)</p>
                    }

                    @if (maPhieuNhap != null)
                    {
                        <hr />
                        <p><b>Mã phiếu:</b> @maPhieuNhap</p>
                        <p><b>Ngày nhập:</b> @ngayNhapKho?.ToString("dd/MM/yyyy HH:mm")</p>
                    }
                </div>
            </div>
        </div>

    </div>
</div>

@code {
    private string? maPhieuNhap;
    private DateTime? ngayNhapKho;
    private List<Product> products = new();
    private List<Product> filteredProducts = new();
    private List<string> brands = new();

    private string? selectedBrand;
    private Product? selectedProduct;
    private int soLuongNhap = 1;
    private string? ghiChu;
    private string? errorMessage;
    private string? successMessage;

    protected override void OnInitialized()
    {
        products = _context.Products.ToList();
        brands = products.Select(p => p.Brand)
                         .Where(b => !string.IsNullOrWhiteSpace(b))
                         .Distinct()
                         .OrderBy(b => b)
                         .ToList();

        filteredProducts = products;
    }

    private void OnBrandChanged(ChangeEventArgs e)
    {
        selectedBrand = e.Value?.ToString();
        selectedProduct = null;

        if (string.IsNullOrWhiteSpace(selectedBrand))
            filteredProducts = products;
        else
            filteredProducts = products.Where(p => p.Brand == selectedBrand).ToList();
    }

    private void OnProductChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedProduct = _context.Products.FirstOrDefault(p => p.Id == id);
        }
    }

    private async Task NhapKho()
    {
        errorMessage = null;
        successMessage = null;

        if (selectedProduct == null)
        {
            errorMessage = "Vui lòng chọn sản phẩm.";
            return;
        }

        if (soLuongNhap <= 0)
        {
            errorMessage = "Số lượng phải lớn hơn 0.";
            return;
        }

        // Cập nhật tồn kho
        selectedProduct.Stock += soLuongNhap;

        var log = new InventoryLog
        {
            CreatedAt = DateTime.Now,
            ProductName = selectedProduct.Name,
            SKU = selectedProduct.SKU,
            Quantity = soLuongNhap,
            Type = "Nhập",
            StaffName = "Admin",
            Note = ghiChu ?? ""
        };

        _context.InventoryLogs.Add(log);
        await _context.SaveChangesAsync();

        // ✅ TẠO MÃ PHIẾU SAU KHI CÓ ID
        ngayNhapKho = log.CreatedAt;
        maPhieuNhap = $"{log.Id}-{ngayNhapKho:ddMMyy}";

        successMessage = "Nhập kho thành công!";

        StateHasChanged();

        
    }
}