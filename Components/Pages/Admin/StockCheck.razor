@page "/admin/stock-check"
@layout Components.Layout.AdminLayout
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using QuanLyKho.Data
@using QuanLyKho.Models
@inject AppDbContext Db
@inject IJSRuntime JS

<PageTitle>Kiểm kê kho</PageTitle>

<div class="container-fluid px-4 h-100 d-flex flex-column">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
        <div>
            <h2 class="fw-bold mb-0 text-dark">Kiểm Kê Kho</h2>
            <p class="text-muted mb-0">Đối chiếu tồn kho hệ thống và thực tế</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-warning fw-bold shadow-sm" @onclick="ResetForm">
                <i class="bi bi-arrow-counterclockwise"></i> Làm mới
            </button>
            <button class="btn btn-primary fw-bold shadow-sm" @onclick="CanBangKho">
                <i class="bi bi-check2-circle"></i> Cân bằng kho
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-3 bg-white flex-shrink-0">
        <div class="card-body p-3">
            <input type="text" class="form-control border-0 bg-light"
                   placeholder="Tìm sản phẩm để kiểm kê..."
                   @bind="searchTerm"
                   @bind:event="oninput" />
        </div>
    </div>

    <div class="card border-0 shadow-sm flex-grow-1 overflow-hidden" style="min-height: 0;">

        <div class="table-responsive" style="max-height: 65vh; overflow-y: auto;">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light" style="position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <tr class="fw-bold text-secondary small text-uppercase">
                        <th class="ps-4 bg-light">Sản phẩm</th>
                        <th class="bg-light">Mã SKU</th>
                        <th class="text-center bg-light">Tồn trên máy</th>
                        <th class="text-center bg-light" style="width: 150px;">Thực tế (Nhập)</th>
                        <th class="text-center bg-light">Chênh lệch</th>
                        <th class="text-center bg-light pe-3">Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    @if (FilteredList.Any())
                    {
                        @foreach (var item in FilteredList)
                        {
                            <tr class="bg-white">
                                <td class="ps-4 fw-bold text-dark">
                                    @item.ProductName
                                    <div class="small text-muted fw-normal">@item.Brand</div>
                                </td>
                                <td class="text-muted">@item.SKU</td>
                                <td class="text-center fw-bold">@item.SystemStock</td>
                                <td class="text-center">
                                    <input type="number"
                                           class="form-control text-center fw-bold @(item.Difference != 0 ? "border-warning text-warning" : "")"
                                           @bind="item.ActualStock"
                                           @bind:event="oninput"
                                           style="max-width: 120px; margin: auto;" />
                                </td>
                                <td class="text-center fw-bold @(item.Difference < 0 ? "text-danger" : (item.Difference > 0 ? "text-success" : "text-muted"))">
                                    @(item.Difference > 0 ? "+" : "")@item.Difference
                                </td>
                                <td class="text-center pe-3">
                                    @if (item.Difference == 0)
                                    {
                                        <span class="badge bg-success-subtle text-success rounded-pill px-3">Khớp</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning-subtle text-warning border border-warning rounded-pill px-3">Lệch</span>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                Không tìm thấy sản phẩm nào.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    // ViewModel
    public class StockCheckItem
    {
        public int SpItemId { get; set; }
        public string ProductName { get; set; } = "";
        public string Brand { get; set; } = "";
        public string SKU { get; set; } = "";
        public int SystemStock { get; set; }
        public int ActualStock { get; set; }
        public int Difference => ActualStock - SystemStock;
    }

    private List<StockCheckItem> itemList = new();
    private string searchTerm = "";

    protected override void OnInitialized()
    {
        LoadData();
    }

    private void LoadData()
    {
        itemList = Db.ProductItems
            .Include(i => i.Product)
            .ThenInclude(p => p.Brand)
            .Select(i => new StockCheckItem
            {
                SpItemId = i.Sp_item_id,
                ProductName = i.Product.Sp_name + " (" + i.Color + "-" + i.Storage + ")",
                Brand = i.Product.Brand.Brand_name,
                SKU = i.SKU,
                SystemStock = i.StockQuantity,
                ActualStock = i.StockQuantity
            })
            .ToList();
    }

    private IEnumerable<StockCheckItem> FilteredList =>
        itemList.Where(x => string.IsNullOrWhiteSpace(searchTerm) ||
                            x.ProductName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                            x.SKU.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    private void ResetForm()
    {
        LoadData();
        searchTerm = "";
    }

    private async Task CanBangKho()
    {
        var diffItems = itemList.Where(x => x.Difference != 0).ToList();

        if (!diffItems.Any())
        {
            await JS.InvokeVoidAsync("alert", "Kho đã khớp hoàn toàn, không cần cân bằng!");
            return;
        }

        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Bạn có chắc muốn cập nhật tồn kho cho {diffItems.Count} sản phẩm bị lệch không?");
        if (!confirmed) return;

        using var transaction = Db.Database.BeginTransaction();
        try
        {
            var inventoryTrans = new InventoryTransaction
            {
                UserID = 1,
                Type = "Kiểm kê",
                TransactionDate = DateTime.Now,
                Note = $"Cân bằng kho ngày {DateTime.Now:dd/MM/yyyy}. Có {diffItems.Count} mục điều chỉnh."
            };
            Db.InventoryTransactions.Add(inventoryTrans);
            await Db.SaveChangesAsync();

            foreach (var item in diffItems)
            {
                var dbItem = await Db.ProductItems.FindAsync(item.SpItemId);
                if (dbItem != null)
                {
                    dbItem.StockQuantity = item.ActualStock;

                    var detail = new TransactionDetail
                    {
                        TransactionID = inventoryTrans.TransactionID,
                        Sp_item_ID = item.SpItemId,
                        Quantity = Math.Abs(item.Difference),
                        UnitPrice = dbItem.Price
                    };
                    Db.TransactionDetails.Add(detail);
                }
            }

            await Db.SaveChangesAsync();
            await transaction.CommitAsync();

            await JS.InvokeVoidAsync("alert", "Cân bằng kho thành công!");
            LoadData();
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync();
            await JS.InvokeVoidAsync("alert", "Lỗi: " + ex.Message);
        }
    }
}