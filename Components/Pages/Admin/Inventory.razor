@page "/admin/inventory"
@using System.Globalization
@layout AdminLayout
@rendermode InteractiveServer
@inject NavigationManager Nav

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold mb-0 text-gray-800">Qu·∫£n l√Ω T·ªìn kho</h2>
            <p class="text-muted">Ki·ªÉm so√°t Nh·∫≠p - Xu·∫•t - T·ªìn</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success shadow-sm fw-bold" @onclick='() => Nav.NavigateTo("/admin/import")'>
                <i class="bi bi-box-arrow-in-down"></i> Nh·∫≠p kho
            </button>
            <button class="btn btn-danger shadow-sm fw-bold" @onclick='() => Nav.NavigateTo("/admin/export")'>
                <i class="bi bi-box-arrow-up"></i> Xu·∫•t kho
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-2">
            <div class="input-group border-0">
                <span class="input-group-text bg-white border-0 text-muted"><i class="bi bi-search"></i></span>
                <input class="form-control border-0 shadow-none"
                       placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..."
                       @bind="SearchTerm"
                       @bind:event="oninput" />
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr class="text-secondary small fw-bold text-uppercase">
                        <th class="ps-4 py-3">S·∫£n ph·∫©m</th>
                        <th>SKU</th>
                        <th>H√£ng</th>
                        <th class="text-center text-success">T·ªïng Nh·∫≠p</th>
                        <th class="text-center text-danger">T·ªïng Xu·∫•t</th>
                        <th class="text-center text-primary">T·ªìn kho</th>
                        <th class="text-center pe-4" style="min-width: 100px;">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @if (FilteredProducts.Any())
                    {
                        @foreach (var prod in FilteredProducts)
                        {
                            <tr @key="prod.Id">
                                <td class="ps-4">
                                    <div class="fw-bold text-dark fs-6">@prod.Name</div>
                                    <small class="text-muted text-uppercase" style="font-size: 0.8rem;">@prod.Storage</small>
                                </td>
                                <td class="text-muted">@prod.SKU</td>
                                <td>
                                    <span class="badge rounded-pill px-3 py-2 @GetBrandBadgeClass(prod.Brand)">
                                        @prod.Brand
                                    </span>
                                </td>
                                
                                <td class="text-center text-success fw-bold fs-6">
                                    @prod.TotalImport
                                </td>
                                
                                <td class="text-center text-danger fw-bold fs-6">
                                    @prod.TotalExport
                                </td>
                                
                                <td class="text-center">
                                    <span class="text-primary fw-bold fs-5">
                                        @prod.Stock
                                    </span>
                                </td>
                                
                               <td class="text-end pe-4">
                                <button type="button"
                                    class="btn btn-sm"
                                    title="S·ª≠a"
                                    @onclick="() => OpenEditModal(prod)">
                                   ‚úèÔ∏è
                                </button>
                               <button type="button"
                                    class="btn btn-sm"
                                    title="X√≥a"
                                    @onclick="() => ConfirmDelete(prod)">
                                    üóëÔ∏è
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 opacity-50"></i>
                                <div class="mt-2">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (IsShowModal)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5); z-index:1050">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="fw-bold mb-0">Ch·ªânh s·ª≠a th√¥ng tin</h5>
                    <button class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">T√™n s·∫£n ph·∫©m</label>
                        <input class="form-control" @bind="EditingProduct.Name" />
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold">H√£ng</label>
                            <select class="form-select" @bind="EditingProduct.Brand">
                                <option>Apple</option>
                                <option>Samsung</option>
                                <option>Xiaomi</option>
                                <option>Oppo</option>
                                <option>Google</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold">Dung l∆∞·ª£ng</label>
                            <input class="form-control" @bind="EditingProduct.Storage" />
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-6 mb-3">
                            <label class="form-label fw-bold">T·ªïng Nh·∫≠p</label>
                            <input type="number" class="form-control" @bind="EditingProduct.TotalImport" />
                        </div>
                         <div class="col-6 mb-3">
                            <label class="form-label fw-bold">T·ªïng Xu·∫•t</label>
                            <input type="number" class="form-control" @bind="EditingProduct.TotalExport" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">H·ªßy</button>
                    <button class="btn btn-warning" @onclick="SaveProduct">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    </div>
}

@if (ShowDeleteConfirm)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5); z-index:1060">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-body text-center p-4">
                    <div class="text-danger mb-3">
                        <i class="bi bi-exclamation-circle" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="fw-bold mb-2">X√°c nh·∫≠n x√≥a?</h5>
                    <p class="text-muted mb-4">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c v·ªõi <strong>@DeletingProduct?.Name</strong>.</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-secondary px-4" @onclick="() => ShowDeleteConfirm = false">H·ªßy</button>
                        <button class="btn btn-danger px-4" @onclick="DeleteProduct">X√≥a ngay</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    public class Product
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string SKU { get; set; } = "";
        public string Brand { get; set; } = "";
        public string Storage { get; set; } = "";
        public int TotalImport { get; set; }
        public int TotalExport { get; set; }
        public int Stock => TotalImport - TotalExport; 
    }

    private string SearchTerm = "";
    private bool IsShowModal;
    private bool ShowDeleteConfirm;
    private Product EditingProduct = new();
    private Product? DeletingProduct;

    private List<Product> products = new List<Product>
    {
        new Product { Id = 1, Name = "iPhone 17 Pro Max", SKU = "IP17-PM-256", Brand = "Apple", Storage = "256GB", TotalImport = 30, TotalExport = 15 },
        new Product { Id = 2, Name = "Samsung Galaxy S26 Ultra", SKU = "SS-S26U-512", Brand = "Samsung", Storage = "512GB", TotalImport = 30, TotalExport = 22 },
        new Product { Id = 3, Name = "Xiaomi 16 Pro", SKU = "XI-16P-256", Brand = "Xiaomi", Storage = "256GB", TotalImport = 30, TotalExport = 30 },
        new Product { Id = 4, Name = "Oppo Find X9", SKU = "OP-X9-128", Brand = "Oppo", Storage = "128GB", TotalImport = 30, TotalExport = 6 },
        new Product { Id = 5, Name = "Google Pixel 10", SKU = "GG-P10-256", Brand = "Google", Storage = "256GB", TotalImport = 30, TotalExport = 27 }
    };

    private List<Product> FilteredProducts => products
        .Where(p => string.IsNullOrWhiteSpace(SearchTerm) || 
                    p.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) || 
                    p.Brand.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase))
        .ToList();

    private void OpenEditModal(Product p)
    {
        EditingProduct = new Product
        {
            Id = p.Id, Name = p.Name, SKU = p.SKU, Brand = p.Brand, 
            Storage = p.Storage, TotalImport = p.TotalImport, TotalExport = p.TotalExport
        };
        IsShowModal = true;
    }

    private void SaveProduct()
    {
        var p = products.FirstOrDefault(x => x.Id == EditingProduct.Id);
        if (p != null)
        {
            p.Name = EditingProduct.Name;
            p.Brand = EditingProduct.Brand;
            p.Storage = EditingProduct.Storage;
            p.TotalImport = EditingProduct.TotalImport;
            p.TotalExport = EditingProduct.TotalExport;
        }
        IsShowModal = false;
    }

    private void ConfirmDelete(Product p)
    {
        DeletingProduct = p;
        ShowDeleteConfirm = true;
    }

    private void DeleteProduct()
    {
        if (DeletingProduct != null) products.Remove(DeletingProduct);
        ShowDeleteConfirm = false;
    }

    private void CloseModal() => IsShowModal = false;

    private string GetBrandBadgeClass(string brand) => brand switch
    {
        "Apple" => "bg-dark text-white",
        "Samsung" => "bg-primary text-white",
        "Xiaomi" => "bg-warning text-dark",
        "Oppo" => "bg-success text-white",
        "Google" => "bg-secondary text-white",
        _ => "bg-light text-dark border"
    };
}