@page "/admin/sales"
@layout Components.Layout.AdminLayout
@using QuanLyKho.Data
@using QuanLyKho.Services
@rendermode InteractiveServer

@inject AppDbContext Db
@inject UserSession Session
@inject NavigationManager Nav

<PageTitle>B√°n h√†ng</PageTitle>

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">B√°n H√†ng</h1>
    </div>

    <div class="row">
        <div class="col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Th√¥ng tin ƒë∆°n h√†ng</h6>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }
                    @if (showSuccess)
                    {
                        <div class="alert alert-success">Thanh to√°n th√†nh c√¥ng!</div>
                    }

                    <div class="mb-3">
                        <label class="form-label fw-bold">Ch·ªçn s·∫£n ph·∫©m:</label>
                        <select class="form-select" @onchange="OnProductChange">
                            <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                            @foreach (var prod in products)
                            {
                                <option value="@prod.Id" disabled="@(prod.Stock <= 0)">
                                    @prod.Name - Gi√°: @prod.Price.ToString("N0") - (C√≤n: @prod.Stock)
                                </option>
                            }
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">S·ªë l∆∞·ª£ng:</label>
                            <input type="number" class="form-control" @bind="soLuong" min="1" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">T√™n kh√°ch h√†ng:</label>
                            <input class="form-control" @bind="tenKhachHang" placeholder="Anh A, Ch·ªã B..." />
                        </div>
                    </div>

                    <button class="btn btn-primary w-100 fw-bold" @onclick="ThemVaoGio">
                        <i class="bi bi-cart-plus"></i> Th√™m v√†o ƒë∆°n
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-success text-white">
                    <h6 class="m-0 font-weight-bold">Gi·ªè h√†ng hi·ªán t·∫°i</h6>
                </div>
                <div class="card-body">
                    @if (cart.Any())
                    {
                        <ul class="list-group mb-3">
                            @foreach (var item in cart)
                            {
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <div>
                                        <h6 class="my-0">@item.ProductName</h6>
                                        <small class="text-muted">SL: @item.Quantity x @item.UnitPrice.ToString("N0")</small>
                                    </div>
                                    <span class="text-muted">@item.TotalAmount.ToString("N0")</span>
                                </li>
                            }
                            <li class="list-group-item d-flex justify-content-between bg-light">
                                <span class="fw-bold">T·ªîNG C·ªòNG (VNƒê)</span>
                                <strong class="text-success">@cart.Sum(x => x.TotalAmount).ToString("N0")</strong>
                            </li>
                        </ul>
                        <button class="btn btn-success w-100 fw-bold" @onclick="ThanhToan">
                            üí∞ X√ÅC NH·∫¨N THANH TO√ÅN
                        </button>
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Product> products = new();
    private List<Order> cart = new();

    private int selectedProductId;
    private int soLuong = 1;
    private string tenKhachHang = "";
    private string errorMessage = "";
    private bool showSuccess = false;

    protected override void OnInitialized()
    {
        LoadProducts();
    }

    private void LoadProducts()
    {
        // L·∫•y danh s√°ch s·∫£n ph·∫©m t·ª´ DB
        products = Db.Products.ToList();
    }

    private void OnProductChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedProductId = id;
        }
    }

    private void ThemVaoGio()
    {
        errorMessage = "";
        showSuccess = false;

        var product = products.FirstOrDefault(p => p.Id == selectedProductId);
        if (product == null)
        {
            errorMessage = "Vui l√≤ng ch·ªçn s·∫£n ph·∫©m!";
            return;
        }

        if (soLuong <= 0)
        {
            errorMessage = "S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0!";
            return;
        }

        if (soLuong > product.Stock)
        {
            errorMessage = $"Kho ch·ªâ c√≤n {product.Stock} s·∫£n ph·∫©m!";
            return;
        }

        // T·∫°o item t·∫°m t√≠nh
        var orderItem = new Order
        {
            ProductName = product.Name,
            Quantity = soLuong,
            UnitPrice = product.Price,
            TotalAmount = product.Price * soLuong,
            CustomerName = tenKhachHang,
            StaffName = Session.CurrentUser?.Username ?? "Admin",
            OrderDate = DateTime.Now
        };

        // Tr·ª´ t·ªìn kho t·∫°m th·ªùi tr√™n giao di·ªán (ch∆∞a l∆∞u DB) ƒë·ªÉ tr√°nh ch·ªçn qu√°
        product.Stock -= soLuong;

        cart.Add(orderItem);
        soLuong = 1; // Reset s·ªë l∆∞·ª£ng
    }

    private void ThanhToan()
    {
        if (!cart.Any()) return;

        // L∆∞u danh s√°ch ƒë∆°n h√†ng v√†o b·∫£ng Orders
        Db.Orders.AddRange(cart);

        // C·∫≠p nh·∫≠t l·∫°i t·ªìn kho th·∫≠t trong b·∫£ng Products
        // L∆∞u √Ω: Logic tr·ª´ t·ªìn kho tr√™n list 'products' ƒë√£ l√†m ·ªü b∆∞·ªõc ThemVaoGio,
        // nh∆∞ng Entity Framework c·∫ßn bi·∫øt ƒë·ªÉ update xu·ªëng SQL.
        // V√¨ 'products' ƒë∆∞·ª£c load t·ª´ DbContext, n√™n khi g·ªçi SaveChanges n√≥ s·∫Ω t·ª± update.

        Db.SaveChanges();

        cart.Clear();
        showSuccess = true;
        tenKhachHang = "";
    }
}