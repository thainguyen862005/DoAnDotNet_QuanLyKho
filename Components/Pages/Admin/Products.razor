@page "/admin/products"
@using QuanLyKho.Data
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@layout Components.Layout.AdminLayout

@inject AppDbContext Db
@inject NavigationManager Nav

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold mb-0">Qu·∫£n l√Ω s·∫£n ph·∫©m</h2>
            <p class="text-muted">D·ªØ li·ªáu th·ª±c t·ª´ Database (SQL Server)</p>
        </div>
        <button type="button" class="btn btn-success px-4 py-2 fw-bold" @onclick="OpenAddModal">
            <i class="bi bi-plus-circle"></i> + Th√™m s·∫£n ph·∫©m
        </button>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-2">
            <div class="input-group border-0">
                <span class="input-group-text bg-white border-0 text-muted">üîç</span>
                <input class="form-control border-0 shadow-none"
                       placeholder=" T√¨m theo t√™n, SKU, h√£ng..."
                       @bind="SearchTerm"
                       @bind:event="oninput" />
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr class="text-secondary small fw-bold text-uppercase" style="font-size: 11px;">
                    <th class="ps-4 py-3">S·∫£n ph·∫©m</th>
                    <th>SKU</th>
                    <th>Danh m·ª•c</th>
                    <th class="text-end">Gi√°</th>
                    <th class="text-center">T·ªìn kho</th>
                    <th class="text-center">Tr·∫°ng th√°i</th>
                    <th class="text-end pe-4">Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                @if (FilteredProducts.Any())
                {
                    @foreach (var prod in FilteredProducts)
                    {
                        <tr @key="prod.Id">
                            <td class="ps-4">
                                <div class="fw-bold">@prod.Name</div>
                                <small class="text-muted text-uppercase">Dung l∆∞·ª£ng: @prod.Storage</small>
                            </td>
                            <td class="text-muted">@prod.SKU</td>
                            <td>
                                <span class="badge rounded-pill px-3 py-2 @GetBrandBadgeClass(prod.Brand)">
                                    @prod.Brand
                                </span>
                            </td>
                            <td class="text-end fw-bold text-primary">@prod.Price.ToString("N0")ƒë</td>
                            <td class="text-center">
                                <span class="@(prod.Stock < 5 ? "text-danger fw-bold" : "")">
                                    @prod.Stock m√°y
                                </span>
                            </td>
                            <td class="text-center">
                                @if (prod.Stock > 0)
                                {
                                    <span class="badge rounded-pill px-3 py-2" style="background-color: #e6f7ed; color: #10b981;">S·∫µn h√†ng</span>
                                }
                                else
                                {
                                    <span class="badge rounded-pill px-3 py-2 bg-danger-subtle text-danger">H·∫øt h√†ng</span>
                                }
                            </td>
                            <td class="text-end pe-4">
                                <button type="button" class="btn btn-sm" title="S·ª≠a" @onclick="() => OpenEditModal(prod)">
                                    ‚úèÔ∏è
                                </button>
                                <button type="button" class="btn btn-sm" title="X√≥a" @onclick="() => ConfirmDelete(prod)">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <img src="https://cdn-icons-png.flaticon.com/512/4076/4076549.png" width="50" class="mb-2 opacity-50" />
                            <div>
                                @if (products.Count == 0)
                                {
                                    <span>Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y th√™m s·∫£n ph·∫©m m·ªõi!</span>
                                }
                                else
                                {
                                    <span>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o ph√π h·ª£p.</span>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (IsShowModal)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5); z-index:1050" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="fw-bold">@(IsEdit ? "S·ª≠a s·∫£n ph·∫©m" : "Th√™m s·∫£n ph·∫©m")</h5>
                    <button class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">T√™n s·∫£n ph·∫©m</label>
                        <input class="form-control" @bind="EditingProduct.Name" placeholder="V√≠ d·ª•: iPhone 15 Pro..." />
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label>M√£ SKU</label>
                            <input class="form-control" @bind="EditingProduct.SKU" placeholder="IP-15-PRO" />
                        </div>
                        <div class="col-6 mb-3">
                            <label>H√£ng</label>
                            <select class="form-select" @bind="EditingProduct.Brand">
                                <option value="">-- Ch·ªçn --</option>
                                <option>Apple</option>
                                <option>Samsung</option>
                                <option>Xiaomi</option>
                                <option>Oppo</option>
                                <option>Google</option>
                                <option>Kh√°c</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label>Dung l∆∞·ª£ng</label>
                            <input class="form-control" @bind="EditingProduct.Storage" placeholder="256GB" />
                        </div>
                        <div class="col-6 mb-3">
                            <label>Gi√° b√°n (VNƒê)</label>
                            <input type="number" class="form-control" @bind="EditingProduct.Price" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label>S·ªë l∆∞·ª£ng t·ªìn kho ban ƒë·∫ßu</label>
                        <input type="number" class="form-control" @bind="EditingProduct.Stock" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">H·ªßy</button>
                    <button class="btn btn-success" @onclick="SaveProduct">L∆∞u d·ªØ li·ªáu</button>
                </div>
            </div>
        </div>
    </div>
}

@if (ShowDeleteConfirm)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <h5 class="fw-bold mb-3 text-danger">X√≥a s·∫£n ph·∫©m n√†y?</h5>
                    <p class="text-muted">H√†nh ƒë·ªông n√†y s·∫Ω x√≥a <strong>@DeletingProduct?.Name</strong> kh·ªèi Database vƒ©nh vi·ªÖn.</p>
                    <div class="mt-4">
                        <button class="btn btn-secondary me-2" @onclick="() => ShowDeleteConfirm = false">H·ªßy</button>
                        <button class="btn btn-danger" @onclick="DeleteProduct">X√°c nh·∫≠n X√≥a</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Product> products = new();
    private string SearchTerm = "";
    private bool IsShowModal;
    private bool IsEdit;
    private bool ShowDeleteConfirm;

    private Product EditingProduct = new();
    private Product? DeletingProduct;
    protected override void OnInitialized()
    {
        LoadData();
    }

    private void LoadData()
    {
        products = Db.Products.OrderByDescending(p => p.Id).ToList();
    }

    private List<Product> FilteredProducts => products
        .Where(p => string.IsNullOrWhiteSpace(SearchTerm) ||
                    p.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (p.SKU != null && p.SKU.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) ||
                    (p.Brand != null && p.Brand.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)))
        .ToList();

    private void OpenAddModal()
    {
        EditingProduct = new Product();
        IsEdit = false;
        IsShowModal = true;
    }

    private void OpenEditModal(Product p)
    {
        EditingProduct = new Product
        {
            Id = p.Id,
            Name = p.Name,
            SKU = p.SKU,
            Brand = p.Brand,
            Storage = p.Storage,
            Price = p.Price,
            Stock = p.Stock
        };
        IsEdit = true;
        IsShowModal = true;
    }

    private void SaveProduct()
    {
        if (string.IsNullOrWhiteSpace(EditingProduct.Name)) return;

        if (IsEdit)
        {
            var productInDb = Db.Products.FirstOrDefault(x => x.Id == EditingProduct.Id);
            if (productInDb != null)
            {
                productInDb.Name = EditingProduct.Name;
                productInDb.SKU = EditingProduct.SKU;
                productInDb.Brand = EditingProduct.Brand;
                productInDb.Storage = EditingProduct.Storage;
                productInDb.Price = EditingProduct.Price;
                productInDb.Stock = EditingProduct.Stock;
                
                Db.SaveChanges();
            }
        }
        else
        {
            if (string.IsNullOrEmpty(EditingProduct.SKU)) 
                EditingProduct.SKU = $"SP-{DateTime.Now.Ticks % 10000}";

            Db.Products.Add(EditingProduct);
            Db.SaveChanges();
        }

        IsShowModal = false;
        LoadData();
    }

    private void ConfirmDelete(Product p)
    {
        DeletingProduct = p;
        ShowDeleteConfirm = true;
    }

    private void DeleteProduct()
    {
        if (DeletingProduct != null)
        {
            var productInDb = Db.Products.FirstOrDefault(x => x.Id == DeletingProduct.Id);
            if (productInDb != null)
            {
                Db.Products.Remove(productInDb);
                Db.SaveChanges();
            }
        }
        ShowDeleteConfirm = false;
        LoadData();
    }

    private void CloseModal() => IsShowModal = false;

    private string GetBrandBadgeClass(string brand) => brand switch
    {
        "Apple" => "bg-dark text-white",
        "Samsung" => "bg-primary text-white",
        "Xiaomi" => "bg-warning text-dark",
        "Oppo" => "bg-success text-white",
        "Google" => "bg-secondary text-white",
        _ => "bg-light text-dark border"
    };
}