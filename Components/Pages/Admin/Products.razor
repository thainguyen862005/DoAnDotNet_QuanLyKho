@page "/admin/products"
@using QuanLyKho.Data
@using QuanLyKho.Models
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@layout Components.Layout.AdminLayout

@inject AppDbContext Db

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold mb-0">Qu·∫£n l√Ω s·∫£n ph·∫©m</h2>
            <p class="text-muted">Danh s√°ch bi·∫øn th·ªÉ s·∫£n ph·∫©m trong kho</p>
        </div>
        <button class="btn btn-success px-4 py-2 fw-bold" @onclick="OpenAddModal">
            <i class="bi bi-plus-circle"></i> + Th√™m s·∫£n ph·∫©m
        </button>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-2">
            <input class="form-control"
                   placeholder="T√¨m theo t√™n, SKU, h√£ng..."
                   @bind="SearchTerm"
                   @bind:event="oninput" />
        </div>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr class="text-secondary small fw-bold text-uppercase" style="font-size: 11px;">
                    <th class="ps-4 py-3">S·∫£n ph·∫©m</th>
                    <th>SKU</th>
                    <th>H√£ng</th>
                    <th>Dung l∆∞·ª£ng</th>
                    <th class="text-end">Gi√°</th>
                    <th class="text-center">T·ªìn kho</th>
                    <th class="text-end pe-4">Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                @if (FilteredItems.Any())
                {
                    @foreach (var item in FilteredItems)
                    {
                        <tr>
                            <td class="ps-4 fw-bold">@item.Product?.Sp_name</td>
                            <td>@item.SKU</td>
                            <td>@item.Product?.Brand?.Brand_name</td>
                            <td>@item.Storage</td>
                            <td class="text-end text-primary fw-bold">@item.Price.ToString("N0") ƒë</td>
                            <td class="text-center">
                                <span class="@(item.StockQuantity < 5 ? "text-danger fw-bold" : "")">
                                    @item.StockQuantity
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm" @onclick="() => OpenEditModal(item)">‚úèÔ∏è</button>
                                <button class="btn btn-sm" @onclick="() => ConfirmDelete(item)">üóëÔ∏è</button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            Kh√¥ng c√≥ d·ªØ li·ªáu
                            </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (IsShowModal)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="fw-bold">@(IsEdit ? "S·ª≠a s·∫£n ph·∫©m" : "Th√™m s·∫£n ph·∫©m")</h5>
                    <button class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>T√™n s·∫£n ph·∫©m</label>
                        <input class="form-control" @bind="EditingProductName" />
                    </div>

                    <div class="mb-3">
                        <label>H√£ng</label>
                        <select class="form-select" @bind="EditingBrandId">
                            @foreach (var b in Brands)
                            {
                                <option value="@b.Brand_Id">@b.Brand_name</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label>SKU</label>
                        <input class="form-control" @bind="EditingItem.SKU" />
                    </div>

                    <div class="mb-3">
                        <label>Dung l∆∞·ª£ng</label>
                        <input class="form-control" @bind="EditingItem.Storage" />
                    </div>

                    <div class="mb-3">
                        <label>Gi√°</label>
                        <input type="number" class="form-control" @bind="EditingItem.Price" />
                    </div>

                    <div class="mb-3">
                        <label>T·ªìn kho</label>
                        <input type="number" class="form-control" @bind="EditingItem.StockQuantity" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">H·ªßy</button>
                    <button class="btn btn-success" @onclick="SaveProduct">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<ProductItem> items = new();
    private List<Brand> Brands = new();
    private string SearchTerm = "";

    private bool IsShowModal;
    private bool IsEdit;

    private ProductItem EditingItem = new();
    private string EditingProductName = "";
    private int EditingBrandId;

    protected override void OnInitialized()
    {
        LoadData();
    }

    private void LoadData()
    {
        items = Db.ProductItems
            .Include(i => i.Product)
            .ThenInclude(p => p.Brand)
            .OrderByDescending(i => i.Sp_item_id)
            .ToList();

        Brands = Db.Brands.ToList();
    }
    private List<ProductItem> FilteredItems => items
        .Where(i => string.IsNullOrWhiteSpace(SearchTerm) ||
                    i.Product!.Sp_name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (i.SKU != null && i.SKU.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) ||
                    (i.Product!.Brand!.Brand_name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)))
        .ToList();

    private void OpenAddModal()
    {
        EditingItem = new ProductItem();
        EditingProductName = "";
        EditingBrandId = Brands.FirstOrDefault()?.Brand_Id ?? 1;
        IsEdit = false;
        IsShowModal = true;
    }

    private void OpenEditModal(ProductItem item)
    {
        EditingItem = item;
        EditingProductName = item.Product?.Sp_name ?? "";
        EditingBrandId = item.Product?.Brands_id ?? 1;
        IsEdit = true;
        IsShowModal = true;
    }

    private void SaveProduct()
    {
        if (IsEdit)
        {
            var product = Db.Products.First(p => p.Sp_id == EditingItem.Sp_id);
            product.Sp_name = EditingProductName;
            product.Brands_id = EditingBrandId;

            Db.ProductItems.Update(EditingItem);
        }
        else
        {
            var product = new Product
            {
                Sp_name = EditingProductName,
                Brands_id = EditingBrandId
            };
            Db.Products.Add(product);
            Db.SaveChanges();

            EditingItem.Sp_id = product.Sp_id;
            Db.ProductItems.Add(EditingItem);
        }

        Db.SaveChanges();
        IsShowModal = false;
        LoadData();
    }

    private void ConfirmDelete(ProductItem item)
    {
        Db.ProductItems.Remove(item);
        Db.SaveChanges();
        LoadData();
    }

    private void CloseModal() => IsShowModal = false;
}