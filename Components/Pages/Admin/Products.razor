@page "/admin/products"
@rendermode InteractiveServer
@layout AdminLayout

@inject IProductService ProductService
@inject IBrandService BrandService
@inject IWebHostEnvironment Env

@using QuanLyKho.Models
@using QuanLyKho.Services
@using QuanLyKho.Components.Layout
@using Microsoft.AspNetCore.Components.Forms

<h3>Qu·∫£n l√Ω s·∫£n ph·∫©m</h3>

<div class="row mb-3">
    <div class="col">
        <input class="form-control"
               placeholder="T√¨m theo t√™n"
               @bind="search"
               @bind:event="oninput" />
    </div>

    <div class="col">
        <select class="form-select" @bind="brandId">
            <option value="0">T·∫•t c·∫£ h√£ng</option>
            @foreach (var b in brands)
            {
                <option value="@b.Brand_Id">@b.Brand_name</option>
            }
        </select>
    </div>

    <div class="col">
        <input type="number"
               class="form-control"
               placeholder="Gi√° t·ª´"
               @bind="minPrice" />
    </div>

    <div class="col">
        <input type="number"
               class="form-control"
               placeholder="Gi√° ƒë·∫øn"
               @bind="maxPrice" />
    </div>

    <div class="col-md-3 text-end">
        <button class="btn btn-success" @onclick="OpenAdd">
            + Th√™m s·∫£n ph·∫©m
        </button>
    </div>
</div>

<table class="table table-bordered align-middle">
    <thead>
        <tr>
            <th>·∫¢nh</th>
            <th>S·∫£n ph·∫©m</th>
            <th>H√£ng</th>
            <th class="text-end">Gi√°</th>
            <th class="text-center">Kho</th>
            <th class="text-end">Thao t√°c</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var p in PagedProducts)
        {
            <tr>
                <td style="width:80px">
                    @if (!string.IsNullOrEmpty(p.ImageUrl))
                    {
                        <img src="@p.ImageUrl" width="60" class="rounded" />
                    }
                </td>
                <td>
                    <div class="fw-bold">@p.Sp_name</div>
                    <div class="text-muted small">
                        M√£: @Sku(p)
                    </div>
                    @if (!string.IsNullOrEmpty(p.Specifications))
                    {
                        <div class="text-secondary small">
                            Dung l∆∞·ª£ng: @p.Specifications
                        </div>
                    }
                </td>
                <td>@p.Brand?.Brand_name</td>

                <td class="text-end fw-bold text-primary">
                    @p.Price.ToString("N0") ‚Ç´
                </td>

                <td class="text-center">
                    <span class="@(p.Quantity == 0 ? "text-danger fw-bold" : "")">
                        @p.Quantity
                    </span>
                </td>

                <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary me-1"
                            @onclick="async () => await ViewDetail(p)">üëÅ</button>
                    <button class="btn btn-sm btn-outline-warning me-1"
                            @onclick="() => OpenEdit(p)">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="() => ConfirmDelete(p)">üóë</button>
                </td>
            </tr>
        }
    </tbody>
</table>
 @if (TotalPages > 1)
    {
        <div class="card-footer d-flex justify-content-between align-items-center">
            <span class="text-muted small">
                Trang @currentPage / @TotalPages
            </span>

            <ul class="pagination mb-0">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => currentPage--">¬´</button>
                </li>

                @for (int i = 1; i <= TotalPages; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <button class="page-link"
                                @onclick="() => currentPage = i">@i</button>
                    </li>
                }

                <li class="page-item @(currentPage == TotalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => currentPage++">¬ª</button>
                </li>
            </ul>
        </div>
    }
@if (ShowForm)
{
    <div class="modal fade show d-block"
         style="background:rgba(0,0,0,.5)">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="fw-bold">
                        @(IsEdit ? "S·ª≠a s·∫£n ph·∫©m" : "Th√™m s·∫£n ph·∫©m")
                    </h5>
                    <button class="btn-close" @onclick="CloseForm"></button>
                </div>
               <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label fw-semibold">T√™n s·∫£n ph·∫©m</label>
                        <input class="form-control"
                            @bind="Editing.Sp_name" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label fw-semibold">Dung l∆∞·ª£ng</label>
                        <input class="form-control"
                            placeholder="256GB, 512GB..."
                            @bind="Editing.Specifications" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label fw-semibold">M√¥ t·∫£ s·∫£n ph·∫©m</label>
                        <textarea class="form-control"
                                rows="3"
                                @bind="Editing.Description"></textarea>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label class="form-label fw-semibold">Gi√° b√°n (‚Ç´)</label>
                            <input type="number" min="0"
                                class="form-control"
                                @bind="Editing.Price" />
                        </div>
                        <div class="col">
                            <label class="form-label fw-semibold">S·ªë l∆∞·ª£ng t·ªìn</label>
                            <input type="number" min="0"
                                class="form-control"
                                @bind="Editing.Quantity" />
                        </div>
                    </div>
                    <div class="mb-2 mt-2">
                        <label class="form-label fw-semibold">H√£ng s·∫£n xu·∫•t</label>
                        <select class="form-select"
                                @bind="Editing.Brands_id">
                            <option value="">-- Ch·ªçn h√£ng --</option>
                            @foreach (var b in brands)
                            {
                                <option value="@b.Brand_Id">@b.Brand_name</option>
                            }
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label fw-semibold">·∫¢nh s·∫£n ph·∫©m</label>
                        <InputFile OnChange="UploadImage" />

                        @if (!string.IsNullOrEmpty(Editing.ImageUrl))
                        {
                            <div class="mt-2">
                                <img src="@Editing.ImageUrl"
                                    width="80"
                                    class="mt-2 rounded" />
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseForm">H·ªßy</button>
                    <button class="btn btn-success" @onclick="Save">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>
}
@if (ShowDetail)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5)">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="fw-bold">Chi ti·∫øt s·∫£n ph·∫©m</h5>
                    <button class="btn-close"
                            @onclick="() => ShowDetail = false"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(Detail.ImageUrl))
                    {
                        <div class="text-center mb-3">
                            <img src="@Detail.ImageUrl"
                                class="img-fluid rounded shadow"
                                style="max-width:250px" />
                        </div>
                    }
                    <h4>@Detail.Sp_name</h4>
                    <p><strong>M√£:</strong> @Sku(Detail)</p>
                    <p><strong>H√£ng:</strong> @Detail.Brand?.Brand_name</p>
                    <p><strong>Dung l∆∞·ª£ng:</strong> @Detail.Specifications</p>
                    <p><strong>M√¥ t·∫£:</strong><br />@Detail.Description</p>
                    <p class="fw-bold text-primary">
                        Gi√°: @Detail.Price.ToString("N0") ‚Ç´
                    </p>
                </div>

            </div>
        </div>
    </div>
}
@if (ShowDelete)
{
    <div class="modal fade show d-block"
         style="background:rgba(0,0,0,.5)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">

                <div class="modal-body text-center p-4">
                    <div class="text-danger fs-1 mb-2">üóë</div>

                    <h5 class="fw-bold mb-2">X√°c nh·∫≠n x√≥a?</h5>

                    <p class="mb-3">
                        B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a<br />
                        <strong class="text-danger">
                            @Deleting?.Sp_name
                        </strong>
                    </p>

                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-danger px-4"
                                @onclick="Delete">
                            X√≥a
                        </button>
                        <button class="btn btn-outline-secondary px-4"
                                @onclick="() => ShowDelete = false">
                            H·ªßy
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
}
@code {
    List<Product> products = new();
    List<Brand> brands = new();

    Product Editing = new();
    Product Detail = new();
    Product? Deleting;

    bool ShowForm;
    bool ShowDelete;
    bool ShowDetail;
    bool IsEdit;

    string search = "";
    int brandId = 0;
    decimal minPrice = 0;
    decimal maxPrice = 100_000_000;

    int currentPage = 1;
    int pageSize = 5;   

    protected override async Task OnInitializedAsync()
    {
        products = await ProductService.GetAllAsync();
        brands = await BrandService.GetAllAsync();
    }

    List<Product> FilteredProducts =>
        products.Where(p =>
            (string.IsNullOrWhiteSpace(search)
                || p.Sp_name.Contains(search, StringComparison.OrdinalIgnoreCase)
                || Sku(p).Contains(search, StringComparison.OrdinalIgnoreCase)) &&
            (brandId == 0 || p.Brands_id == brandId) &&
            p.Price >= minPrice &&
            p.Price <= maxPrice
        ).ToList();

    List<Product> PagedProducts =>
        FilteredProducts
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();

    int TotalPages =>
        (int)Math.Ceiling((double)FilteredProducts.Count / pageSize);

    string Sku(Product p) => $"SP-{p.Sp_id:D6}";

    void OpenAdd()
    {
        Editing = new Product();
        IsEdit = false;
        ShowForm = true;
    }

    void OpenEdit(Product p)
    {
        ShowDelete = false;
        ShowDetail = false;
        Editing = new Product
        {
            Sp_id = p.Sp_id,
            Sp_name = p.Sp_name,
            Specifications = p.Specifications,
            Description = p.Description,
            Price = p.Price,
            Quantity = p.Quantity,
            Brands_id = p.Brands_id,
            ImageUrl = p.ImageUrl
        };
        IsEdit = true;
        ShowForm = true;
    }
    async Task Save()
{
    if (IsEdit)
        await ProductService.UpdateAsync(Editing);
    else
        await ProductService.AddAsync(Editing);

    products = await ProductService.GetAllAsync();
    Detail = new Product();
    ShowForm = false;
}
    async Task ViewDetail(Product p)
{
    var fresh = await ProductService.GetByIdAsync(p.Sp_id);
    if (fresh != null)
    {
        Detail = fresh;
        ShowDetail = true;
    }
}

    void ConfirmDelete(Product p)
    {
        Deleting = p;
        ShowDelete = true;
    }
     async Task Delete()
    {
        if (Deleting != null)
            await ProductService.DeleteAsync(Deleting.Sp_id);

        products = await ProductService.GetAllAsync();
        Deleting = null;
        ShowDelete = false;
        StateHasChanged();
    }
    async Task UploadImage(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var folder = Path.Combine(Env.WebRootPath, "images");
        Directory.CreateDirectory(folder);

        var path = Path.Combine(folder, file.Name);
        await using var fs = new FileStream(path, FileMode.Create);

        await file.OpenReadStream(5 * 1024 * 1024)
                  .CopyToAsync(fs);

        Editing.ImageUrl = "/images/" + file.Name;
    }

    void CloseForm()
{
    Editing = new Product();
    IsEdit = false;
    ShowForm = false;
}
}
