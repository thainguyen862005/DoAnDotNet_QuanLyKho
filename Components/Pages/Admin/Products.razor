@page "/admin/products"
@using QuanLyKho.Data
@using QuanLyKho.Models
@using Microsoft.EntityFrameworkCore
@* QUAN TR·ªåNG: D√≤ng n√†y t·∫Øt Prerender ƒë·ªÉ h·∫øt b·ªã nh√°y *@
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@layout Components.Layout.AdminLayout

@inject AppDbContext Db

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold mb-0">Qu·∫£n l√Ω s·∫£n ph·∫©m</h2>
            <p class="text-muted">Danh s√°ch bi·∫øn th·ªÉ s·∫£n ph·∫©m trong kho</p>
        </div>
        <button class="btn btn-success px-4 py-2 fw-bold shadow-sm" @onclick="OpenAddModal">
            <i class="bi bi-plus-circle"></i> + Th√™m s·∫£n ph·∫©m
        </button>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-2">
            <input class="form-control"
                   placeholder="T√¨m theo t√™n, SKU, h√£ng..."
                   @bind="SearchTerm"
                   @bind:event="oninput" />
        </div>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden" style="min-height: 500px;">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr class="text-secondary small fw-bold text-uppercase" style="font-size: 11px;">
                    <th class="ps-4 py-3" style="width: 80px;">·∫¢nh</th>
                    <th style="width: 25%;">S·∫£n ph·∫©m</th>
                    <th style="width: 15%;">SKU</th>
                    <th style="width: 15%;">H√£ng</th>
                    <th style="width: 15%;">Dung l∆∞·ª£ng</th>
                    <th class="text-end" style="width: 10%;">Gi√°</th>
                    <th class="text-center" style="width: 10%;">T·ªìn kho</th>
                    <th class="text-end pe-4" style="width: 10%;">Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    @* SKELETON: V·∫Ω 5 d√≤ng x√°m gi·ªØ ch·ªó *@
                    @for (int i = 0; i < 5; i++)
                    {
                        <tr>
                            <td class="ps-4">
                                <div class="placeholder-glow">
                                    <span class="placeholder col-12 rounded" style="width: 50px; height: 50px; display:block;"></span>
                                </div>
                            </td>
                            <td><p class="placeholder-glow mb-0"><span class="placeholder col-8"></span></p></td>
                            <td><span class="placeholder-glow"><span class="placeholder col-6"></span></span></td>
                            <td><span class="placeholder-glow"><span class="placeholder col-4"></span></span></td>
                            <td><span class="placeholder-glow"><span class="placeholder col-4"></span></span></td>
                            <td class="text-end"><span class="placeholder-glow"><span class="placeholder col-6"></span></span></td>
                            <td class="text-center"><span class="placeholder-glow"><span class="placeholder col-4"></span></span></td>
                            <td class="text-end pe-4"><span class="placeholder-glow"><span class="placeholder col-6"></span></span></td>
                        </tr>
                    }
                }
                else if (FilteredItems.Any())
                {
                    @foreach (var item in FilteredItems)
                    {
                        <tr>
                            <td class="ps-4">
                                @* C·ªë ƒë·ªãnh width/height ƒë·ªÉ ·∫£nh kh√¥ng ƒë·∫©y layout *@
                                <div style="width: 50px; height: 50px;" class="bg-light rounded border d-flex align-items-center justify-content-center overflow-hidden">
                                    <img src="@(string.IsNullOrEmpty(item.Product?.ImageUrl) ? "/images/no-image.png" : item.Product.ImageUrl)"
                                         style="width: 100%; height: 100%; object-fit: contain;"
                                         alt="SP"
                                         onerror="this.src='/images/no-image.png'" />
                                </div>
                            </td>
                            <td class="fw-bold text-primary">@item.Product?.Sp_name</td>
                            <td>@item.SKU</td>
                            <td>@item.Product?.Brand?.Brand_name</td>
                            <td>@item.Storage</td>
                            <td class="text-end fw-bold">@item.Price.ToString("N0") ƒë</td>
                            <td class="text-center">
                                <span class="@(item.StockQuantity < 5 ? "text-danger fw-bold" : "text-success")">
                                    @item.StockQuantity
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-light text-primary border me-1" @onclick="() => OpenEditModal(item)" title="S·ª≠a">
                                    ‚úèÔ∏è
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-light text-danger border" @onclick="() => ConfirmDelete(item)" title="X√≥a">
                                    üóëÔ∏è
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">
                            Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@* MODAL TH√äM / S·ª¨A *@
@if (IsShowModal)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="fw-bold mb-0">@(IsEdit ? "S·ª≠a s·∫£n ph·∫©m" : "Th√™m s·∫£n ph·∫©m")</h5>
                    <button class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="fw-bold small mb-1">T√™n s·∫£n ph·∫©m</label>
                            <input class="form-control" @bind="EditingProductName" placeholder="V√≠ d·ª•: iPhone 15 Pro Max" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="fw-bold small mb-1">H√£ng</label>
                            <select class="form-select" @bind="EditingBrandId">
                                @foreach (var b in Brands)
                                {
                                    <option value="@b.Brand_Id">@b.Brand_name</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small mb-1">Link ·∫¢nh (URL)</label>
                        <div class="input-group">
                            <input class="form-control" @bind="EditingImageUrl" placeholder="/images/sanpham.png ho·∫∑c https://..." />
                            @if (!string.IsNullOrEmpty(EditingImageUrl))
                            {
                                <span class="input-group-text p-0 overflow-hidden" style="width: 40px;">
                                    <img src="@EditingImageUrl" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='/images/no-image.png'" />
                                </span>
                            }
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold small mb-1">M√£ SKU</label>
                            <input class="form-control" @bind="EditingItem.SKU" placeholder="IP-15-PRO" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold small mb-1">Dung l∆∞·ª£ng / M√†u</label>
                            <input class="form-control" @bind="EditingItem.Storage" placeholder="256GB - Xanh" />
                        </div>
                    </div>

                    
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold small mb-1">Gi√° b√°n</label>
                            <input type="number" class="form-control" @bind="EditingItem.Price" />
                        </div>
                        
                    

                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">H·ªßy</button>
                    <button class="btn btn-success fw-bold" @onclick="SaveProduct">
                        <i class="bi bi-save"></i> L∆∞u th√¥ng tin
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<ProductItem> items = new();
    private List<Brand> Brands = new();
    private string SearchTerm = "";

    // Bi·∫øn tr·∫°ng th√°i loading (M·∫∑c ƒë·ªãnh true ƒë·ªÉ hi·ªán Skeleton)
    private bool isLoading = true;

    private bool IsShowModal;
    private bool IsEdit;
    private ProductItem EditingItem = new();

    private string EditingProductName = "";
    private int EditingBrandId;
    private string EditingImageUrl = "";

    protected override async Task OnInitializedAsync()
    {
        // 1. Gi·∫£ l·∫≠p delay r·∫•t nh·ªè (50ms) ƒë·ªÉ UI k·ªãp v·∫Ω Skeleton tr∆∞·ªõc khi load n·∫∑ng
        // Gi√∫p chuy·ªÉn c·∫£nh m∆∞·ª£t h∆°n
        await Task.Delay(50);
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true; // B·∫≠t skeleton

        // 2. Load d·ªØ li·ªáu B·∫•t ƒë·ªìng b·ªô (Async) ƒë·ªÉ kh√¥ng treo UI
        items = await Db.ProductItems
            .Include(i => i.Product)
            .ThenInclude(p => p.Brand)
            .OrderByDescending(i => i.Sp_item_id)
            .ToListAsync();

        Brands = await Db.Brands.ToListAsync();

        isLoading = false; // T·∫Øt skeleton, hi·ªán b·∫£ng th·∫≠t
    }

    private List<ProductItem> FilteredItems => items
        .Where(i => string.IsNullOrWhiteSpace(SearchTerm) ||
                    (i.Product?.Sp_name?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.SKU?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.Product?.Brand?.Brand_name?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
        .ToList();

    private void OpenAddModal()
    {
        EditingItem = new ProductItem();
        EditingProductName = "";
        EditingImageUrl = "";
        EditingBrandId = Brands.FirstOrDefault()?.Brand_Id ?? 1;
        IsEdit = false;
        IsShowModal = true;
    }

    private void OpenEditModal(ProductItem item)
    {
        EditingItem = item;
        EditingProductName = item.Product?.Sp_name ?? "";
        EditingImageUrl = item.Product?.ImageUrl ?? "";
        EditingBrandId = item.Product?.Brands_id ?? 1;
        IsEdit = true;
        IsShowModal = true;
    }

    private async Task SaveProduct()
    {
        if (IsEdit)
        {
            var product = await Db.Products.FindAsync(EditingItem.Sp_id);
            if (product != null)
            {
                product.Sp_name = EditingProductName;
                product.Brands_id = EditingBrandId;
                product.ImageUrl = EditingImageUrl;
                Db.ProductItems.Update(EditingItem);
            }
        }
        else
        {
            var product = new Product
            {
                Sp_name = EditingProductName,
                Brands_id = EditingBrandId,
                ImageUrl = EditingImageUrl
            };
            Db.Products.Add(product);
            await Db.SaveChangesAsync();

            EditingItem.Sp_id = product.Sp_id;
            Db.ProductItems.Add(EditingItem);
        }

        await Db.SaveChangesAsync();
        IsShowModal = false;
        await LoadDataAsync();
    }

    private async Task ConfirmDelete(ProductItem item)
    {
        Db.ProductItems.Remove(item);
        await Db.SaveChangesAsync();
        await LoadDataAsync();
    }

    private void CloseModal() => IsShowModal = false;
}