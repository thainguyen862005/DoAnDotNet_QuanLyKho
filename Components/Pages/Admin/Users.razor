@page "/admin/users"
@layout Components.Layout.AdminLayout
@using QuanLyKho.Data
@rendermode InteractiveServer
@inject AppDbContext Db
@inject NavigationManager Nav

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold mb-0 text-gray-800">Qu·∫£n l√Ω T√†i kho·∫£n</h2>
            <p class="text-muted">Ki·ªÉm so√°t ng∆∞·ªùi d√πng & ph√¢n quy·ªÅn h·ªá th·ªëng</p>
        </div>
        <div>
            <button class="btn btn-primary shadow-sm fw-bold" @onclick="OpenCreateModal">
                <i class="bi bi-person-plus-fill"></i> Th√™m t√†i kho·∫£n
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-2">
            <div class="input-group border-0">
                <span class="input-group-text bg-white border-0 text-muted"><i class="bi bi-search"></i></span>
                <input class="form-control border-0 shadow-none"
                       placeholder="T√¨m ki·∫øm theo t√™n ng∆∞·ªùi d√πng ho·∫∑c email..."
                       @bind="SearchTerm"
                       @bind:event="oninput" />
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr class="text-secondary small fw-bold text-uppercase">
                        <th class="ps-4 py-3">ID</th>
                        <th>Ng∆∞·ªùi d√πng</th>
                        <th>Email / SƒêT</th>
                        <th class="text-center">Vai tr√≤</th>
                        <th class="text-center">Tr·∫°ng th√°i</th>
                        <th>Ng√†y t·∫°o</th>
                        <th class="text-end pe-4">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @if (FilteredUsers.Any())
                    {
                        @foreach (var user in FilteredUsers)
                        {
                            <tr @key="user.Id">
                                <td class="ps-4 text-muted fw-bold">#@user.Id</td>
                                <td>
                                    <div class="fw-bold text-dark">@user.Username</div>
                                </td>
                                <td>
                                    <div class="text-dark">@user.Email</div>
                                    <small class="text-muted">@user.Phone</small>
                                </td>
                                
                                <td class="text-center">
                                    @if (user.Role == 1)
                                    {
                                        <span class="badge bg-danger rounded-pill px-3">Admin</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-info text-dark rounded-pill px-3">User</span>
                                    }
                                </td>

                                <td class="text-center">
                                    @if (user.Status == "Active")
                                    {
                                        <span class="badge bg-success-subtle text-success border border-success px-2">Ho·∫°t ƒë·ªông</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary-subtle text-secondary border border-secondary px-2">ƒê√£ kh√≥a</span>
                                    }
                                </td>

                                <td class="text-muted small">
                                    @user.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                </td>

                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-light text-primary me-2" title="S·ª≠a" @onclick="() => OpenEditModal(user)">
                                        ‚úèÔ∏è <i class="bi bi-pencil-square"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light text-danger" title="X√≥a" @onclick="() => ConfirmDelete(user)">
                                        üóëÔ∏è <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                <i class="bi bi-person-x fs-1 opacity-50"></i>
                                <div class="mt-2">Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n n√†o</div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="mt-3 text-muted fst-italic">
        * Ch√∫ th√≠ch: Admin l√† 1, Staff l√† 0.
    </div>
</div>

@if (IsShowModal)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5); z-index:1050">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="fw-bold mb-0">@(EditingUser.Id == 0 ? "Th√™m t√†i kho·∫£n m·ªõi" : "Ch·ªânh s·ª≠a t√†i kho·∫£n")</h5>
                    <button class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">T√™n ng∆∞·ªùi d√πng (Username)</label>
                        <input class="form-control" @bind="EditingUser.Username" placeholder="Nh·∫≠p username..." />
                    </div>
                    
                     <div class="mb-3">
                        <label class="form-label fw-bold">M·∫≠t kh·∫©u</label>
                        <input class="form-control" @bind="EditingUser.Password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." />
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <input type="email" class="form-control" @bind="EditingUser.Email" placeholder="name@example.com" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input class="form-control" @bind="EditingUser.Phone" placeholder="09xxxxxxxx" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Vai tr√≤ (Role)</label>
                            <select class="form-select" @bind="EditingUser.Role">
                                <option value="0">Staff (0)</option>
                                <option value="1">Admin (1)</option>
                            </select>
                        </div>
                         <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Tr·∫°ng th√°i</label>
                            <select class="form-select" @bind="EditingUser.Status">
                                <option value="Active">Ho·∫°t ƒë·ªông</option>
                                <option value="Locked">ƒê√£ kh√≥a</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">H·ªßy</button>
                    <button class="btn btn-primary" @onclick="SaveUser">L∆∞u th√¥ng tin</button>
                </div>
            </div>
        </div>
    </div>
}

@if (ShowDeleteConfirm)
{
    <div class="modal fade show d-block" style="background:rgba(0,0,0,.5); z-index:1060">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-body text-center p-4">
                    <div class="text-danger mb-3">
                        <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="fw-bold mb-2">X√°c nh·∫≠n x√≥a t√†i kho·∫£n?</h5>
                    <p class="text-muted mb-4">H√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn user <strong>@DeletingUser?.Username</strong>.</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-secondary px-4" @onclick="() => ShowDeleteConfirm = false">H·ªßy</button>
                        <button class="btn btn-danger px-4" @onclick="DeleteUser">X√≥a ngay</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string SearchTerm = "";
    private bool IsShowModal;
    private bool ShowDeleteConfirm;
    private User EditingUser = new();
    private User? DeletingUser;
    private List<User> users = new();

    protected override void OnInitialized()
    {
        LoadData();
    }

    
    private void LoadData()
    {
        // S·∫Øp x·∫øp ID tƒÉng d·∫ßn (Ascending)
        users = Db.Users.OrderBy(u => u.Id).ToList();
    }

    private List<User> FilteredUsers => users
        .Where(u => string.IsNullOrWhiteSpace(SearchTerm) || 
                    u.Username.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) || 
                    u.Email.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase))
        .ToList();

    private void OpenCreateModal()
    {
        EditingUser = new User { Role = 0, Status = "Active" };
        IsShowModal = true;
    }

    private void OpenEditModal(User u)
    {
        EditingUser = new User
        {
            Id = u.Id,
            Username = u.Username,
            Password = u.Password, 
            Email = u.Email,
            Phone = u.Phone,
            Role = u.Role,
            Status = u.Status,
            CreatedAt = u.CreatedAt
        };
        IsShowModal = true;
    }

    private void SaveUser()
    {
        if (string.IsNullOrWhiteSpace(EditingUser.Username) || string.IsNullOrWhiteSpace(EditingUser.Password))
            return;

        if (EditingUser.Id == 0)
        {
            EditingUser.CreatedAt = DateTime.Now;
            Db.Users.Add(EditingUser);
        }
        else
        {
            var u = Db.Users.FirstOrDefault(x => x.Id == EditingUser.Id);
            if (u != null)
            {
                u.Username = EditingUser.Username;
                u.Password = EditingUser.Password;
                u.Email = EditingUser.Email;
                u.Phone = EditingUser.Phone;
                u.Role = EditingUser.Role;
                u.Status = EditingUser.Status;
            }
        }
        
        Db.SaveChanges();
        IsShowModal = false;
        LoadData();
    }

    private void ConfirmDelete(User u)
    {
        DeletingUser = u;
        ShowDeleteConfirm = true;
    }

    private void DeleteUser()
    {
        if (DeletingUser != null)
        {
            var u = Db.Users.FirstOrDefault(x => x.Id == DeletingUser.Id);
            if (u != null)
            {
                Db.Users.Remove(u);
                Db.SaveChanges();
            }
        }
        ShowDeleteConfirm = false;
        LoadData();
    }

    private void CloseModal() => IsShowModal = false;
}