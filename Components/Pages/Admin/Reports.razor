@page "/admin/reports"
@layout AdminLayout
@using Microsoft.AspNetCore.Components.Web
@rendermode InteractiveServer
@using Microsoft.JSInterop
@using System.Collections.Generic
@using System.Linq

@inject IJSRuntime JS

<PageTitle>B√°o c√°o th·ªëng k√™</PageTitle>

<div class="container-fluid pb-5">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <h3 class="fw-bold text-dark mb-0">üìà Analytics Center</h3>

        <div class="d-flex flex-wrap gap-2 align-items-center">

            @if (viewMode == "custom")
            {
                <div class="d-flex gap-2 bg-white p-1 rounded-pill shadow-sm border align-items-center px-3">
                    <input type="date" class="form-control form-control-sm border-0" style="width: 130px;" @bind="fromDate" />
                    <span class="text-muted fw-bold">-</span>
                    <input type="date" class="form-control form-control-sm border-0" style="width: 130px;" @bind="toDate" />
                    <button class="btn btn-sm btn-primary rounded-circle" @onclick="LoadCustomData">üîç</button>
                </div>
            }

            <button class="btn btn-success btn-sm rounded-pill px-3 shadow-sm fw-bold" @onclick="ExportToExcel">
                üì• Xu·∫•t Excel
            </button>

            <div class="btn-group shadow-sm bg-white rounded-pill p-1">
                <button class="btn btn-sm rounded-pill px-3 fw-bold @(chartType == "bar" ? "btn-primary" : "btn-light text-muted")"
                        @onclick='() => ChangeChartType("bar")'>
                    üìä C·ªôt
                </button>
                <button class="btn btn-sm rounded-pill px-3 fw-bold @(chartType == "line" ? "btn-primary" : "btn-light text-muted")"
                        @onclick='() => ChangeChartType("line")'>
                    üìâ ƒê∆∞·ªùng
                </button>
            </div>

            <div class="btn-group shadow-sm bg-white rounded-pill p-1">
                <button class="btn btn-sm rounded-pill px-3 @(viewMode == "day" ? "btn-dark" : "btn-white text-muted")"
                        @onclick='() => ChangeView("day")'>
                    Ng√†y
                </button>
                <button class="btn btn-sm rounded-pill px-3 @(viewMode == "month" ? "btn-dark" : "btn-white text-muted")"
                        @onclick='() => ChangeView("month")'>
                    Th√°ng
                </button>
                <button class="btn btn-sm rounded-pill px-3 @(viewMode == "year" ? "btn-dark" : "btn-white text-muted")"
                        @onclick='() => ChangeView("year")'>
                    NƒÉm
                </button>
                <button class="btn btn-sm rounded-pill px-3 @(viewMode == "custom" ? "btn-dark" : "btn-white text-muted")"
                        @onclick='() => ChangeView("custom")'>
                    T√πy ch·ªânh
                </button>
            </div>
        </div>
    </div>

    <div class="card shadow-lg border-0 mb-4" style="border-radius: 16px; overflow: hidden;">
        <div class="card-body p-4 bg-white">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-uppercase text-secondary fw-bold" style="letter-spacing: 1px; font-size: 12px;">
                    Bi·ªÉu ƒë·ªì ho·∫°t ƒë·ªông (@GetCurrentModeName())
                </h6>

                <div class="d-flex gap-4">
                    <div class="d-flex align-items-center">
                        <span class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: #3b82f6;"></span>
                        <span class="fw-bold text-secondary" style="font-size: 13px;">Nh·∫≠p kho</span>
                    </div>

                    <div class="d-flex align-items-center">
                        <span class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: #ef4444;"></span>
                        <span class="fw-bold text-secondary" style="font-size: 13px;">Xu·∫•t kho</span>
                    </div>
                </div>
            </div>

            <div style="height: 450px;">
                <canvas id="inventoryChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100" style="border-radius: 16px;">
                <div class="card-body">
                    <h6 class="fw-bold text-dark mb-3">üèÜ Top S·∫£n Ph·∫©m Ti√™u Bi·ªÉu (Th√°ng n√†y)</h6>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="bg-light text-secondary small">
                                <tr>
                                    <th class="border-0 rounded-start">S·∫£n ph·∫©m</th>
                                    <th class="border-0 text-center">ƒê√£ xu·∫•t</th>
                                    <th class="border-0 text-end rounded-end">Doanh thu ∆∞·ªõc t√≠nh</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var prod in topProducts)
                                {
                                    <tr>
                                        <td class="fw-bold text-dark">@prod.Name</td>
                                        <td class="text-center">
                                            <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">
                                                @prod.Quantity m√°y
                                            </span>
                                        </td>
                                        <td class="text-end fw-bold text-success">@prod.Revenue.ToString("N0") ‚Ç´</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100" style="border-radius: 16px;">
                <div class="card-body">
                    <h6 class="fw-bold text-dark mb-3">üç∞ T·ª∑ L·ªá Theo H√£ng</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="p-4 rounded-4 text-white shadow" style="background-color: #3b82f6;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-1 opacity-75 fw-bold text-uppercase small">T·ªïng Nh·∫≠p Kho (@GetCurrentModeName())</p>
                        <h2 class="fw-bold mb-0">@TotalImport.ToString("N0") <span class="fs-6">SP</span></h2>
                    </div>
                    <div class="fs-1 opacity-50">üì•</div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="p-4 rounded-4 text-white shadow" style="background-color: #ef4444;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-1 opacity-75 fw-bold text-uppercase small">T·ªïng Xu·∫•t Kho (@GetCurrentModeName())</p>
                        <h2 class="fw-bold mb-0">@TotalExport.ToString("N0") <span class="fs-6">SP</span></h2>
                    </div>
                    <div class="fs-1 opacity-50">üì§</div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string viewMode = "month";
    private string chartType = "line";
    private double TotalImport = 0;
    private double TotalExport = 0;
    private DateTime fromDate = DateTime.Now.AddDays(-30);
    private DateTime toDate = DateTime.Now;

    public class ProductInfo
    {
        public string Name { get; set; } = "";
        public int Quantity { get; set; }
        public decimal Revenue { get; set; }
    }

    private List<ProductInfo> topProducts = new();

    protected override void OnInitialized()
    {
        topProducts = new List<ProductInfo>
        {
            new ProductInfo { Name = "iPhone 17 Pro Max", Quantity = 45, Revenue = 1484550000 },
            new ProductInfo { Name = "Samsung Galaxy S26 Ultra", Quantity = 38, Revenue = 1121000000 },
            new ProductInfo { Name = "Oppo Find X9", Quantity = 32, Revenue = 496000000 },
            new ProductInfo { Name = "Xiaomi 16 Pro", Quantity = 25, Revenue = 472500000 },
            new ProductInfo { Name = "Google Pixel 10", Quantity = 12, Revenue = 252000000 }
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await RenderChart();
        if (firstRender || viewMode != "")
        {
            await RenderPieChart();
        }
    }

    private async Task ChangeView(string mode)
    {
        viewMode = mode;
        StateHasChanged();
        await RenderChart();
    }

    private async Task ChangeChartType(string type)
    {
        chartType = type;
        await RenderChart();
    }

    private async Task LoadCustomData()
    {
        await RenderChart();
    }

    private string GetCurrentModeName() => viewMode switch
    {
        "day" => "7 ng√†y g·∫ßn nh·∫•t",
        "month" => "12 th√°ng qua",
        "year" => "5 nƒÉm qua",
        "custom" => $"{fromDate:dd/MM} - {toDate:dd/MM}",
        _ => ""
    };

    private async Task ExportToExcel()
    {
        var (labels, dataImport, dataExport) = GetDataByMode(viewMode);
        var csv = "ThoiGian,NhapKho,XuatKho\n";
        for (int i = 0; i < labels.Length; i++)
        {
            csv += $"{labels[i]},{dataImport[i]},{dataExport[i]}\n";
        }

        await JS.InvokeVoidAsync("downloadFile", $"BaoCao_Kho_{DateTime.Now:yyyyMMdd}.csv", csv);
    }

    private async Task RenderChart()
    {
        var (labels, dataImport, dataExport) = GetDataByMode(viewMode);
        TotalImport = dataImport.Sum();
        TotalExport = dataExport.Sum();

        bool isLine = chartType == "line";
        var config = new
        {
            type = chartType,
            data = new
            {
                labels = labels,
                datasets = new[]
                {
                    new {
                        label = "Nh·∫≠p kho",
                        data = dataImport,
                        fill = isLine,
                        tension = 0.4,
                        pointRadius = isLine ? 4 : 0,
                        backgroundColor = isLine ? "rgba(59, 130, 246, 0.2)" : "#3b82f6",
                        borderColor = "#3b82f6",
                        borderWidth = 2,
                        borderRadius = 4
                    },
                    new {
                        label = "Xu·∫•t kho",
                        data = dataExport,
                        fill = isLine,
                        tension = 0.4,
                        pointRadius = isLine ? 4 : 0,
                        backgroundColor = isLine ? "rgba(239, 68, 68, 0.2)" : "#ef4444",
                        borderColor = "#ef4444",
                        borderWidth = 2,
                        borderRadius = 4
                    }
                }
            },
            options = new
            {
                responsive = true,
                maintainAspectRatio = false,
                plugins = new { legend = new { display = false } },
                interaction = new { mode = "index", intersect = false },
                scales = new
                {
                    y = new { beginAtZero = true, grid = new { color = "#f3f4f6" }, border = new { display = false } },
                    x = new { grid = new { display = false }, border = new { display = false } }
                }
            }
        };

        await JS.InvokeVoidAsync("setupChart", "inventoryChart", config);
    }

    private async Task RenderPieChart()
    {
        var config = new
        {
            type = "doughnut",
            data = new
            {
                labels = new[] { "Apple", "Samsung", "Xiaomi", "Oppo", "Google" },
                datasets = new[]
                {
                    new {
                        data = new[] { 35, 25, 20, 15, 5 },
                        backgroundColor = new[] { "#212529", "#0d6efd", "#ffc107", "#198754", "#6c757d" },
                        borderWidth = 0,
                        hoverOffset = 4
                    }
                }
            },
            options = new
            {
                responsive = true,
                maintainAspectRatio = false,
                plugins = new { legend = new { position = "right" } },
                cutout = "75%"
            }
        };
        await JS.InvokeVoidAsync("setupPieChart", "categoryChart", config);
    }

    private (string[], double[], double[]) GetDataByMode(string mode)
    {
        if (mode == "day")
            return (
                new[] { "T2", "T3", "T4", "T5", "T6", "T7", "CN" },
                new double[] { 15, 20, 10, 40, 25, 5, 2 },
                new double[] { 12, 25, 15, 30, 35, 10, 5 }
            );
        else if (mode == "year")
            return (
                new[] { "2021", "2022", "2023", "2024", "2025" },
                new double[] { 1200, 1500, 1100, 1800, 2000 },
                new double[] { 1150, 1400, 1050, 1750, 1900 }
            );
        else if (mode == "custom")
            return (
                new[] { "Tu·∫ßn 1", "Tu·∫ßn 2", "Tu·∫ßn 3", "Tu·∫ßn 4" },
                new double[] { 50, 60, 45, 70 },
                new double[] { 40, 65, 55, 60 }
            );
        else
            return (
                new[] { "T1", "T2", "T3", "T4", "T5", "T6", "T7", "T8", "T9", "T10", "T11", "T12" },
                new double[] { 80, 95, 120, 140, 100, 90, 110, 130, 150, 140, 160, 200 },
                new double[] { 70, 90, 110, 130, 95, 85, 120, 125, 140, 145, 170, 210 }
            );
    }
}