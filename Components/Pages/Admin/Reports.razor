@page "/admin/reports"
@layout AdminLayout
@using Microsoft.AspNetCore.Components.Web
@rendermode InteractiveServer
@using Microsoft.JSInterop
@using System.Collections.Generic
@using System.Linq

@inject IJSRuntime JS

<PageTitle>B√°o c√°o th·ªëng k√™</PageTitle>

<div class="container-fluid pb-5">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <h3 class="fw-bold text-dark mb-0">üìà Analytics Center</h3>

        <div class="d-flex flex-wrap gap-2 align-items-center">

            @if (viewMode == "custom")
            {
                <div class="d-flex gap-2 bg-white p-1 rounded-pill shadow-sm border align-items-center px-3">
                    <input type="date" class="form-control form-control-sm border-0" style="width: 130px;" @bind="fromDate" />
                    <span class="text-muted fw-bold">-</span>
                    <input type="date" class="form-control form-control-sm border-0" style="width: 130px;" @bind="toDate" />
                    <button class="btn btn-sm btn-primary rounded-circle" @onclick="LoadCustomData">üîç</button>
                </div>
            }

            <button class="btn btn-success btn-sm rounded-pill px-3 shadow-sm fw-bold" @onclick="ExportToExcel">
                üì• Xu·∫•t Excel
            </button>

            <div class="btn-group shadow-sm bg-white rounded-pill p-1">
                <button class="btn btn-sm rounded-pill px-3 fw-bold @(chartType == "bar" ? "btn-primary" : "btn-light text-muted")"
                        @onclick='() => ChangeChartType("bar")'>
                    üìä C·ªôt
                </button>
                <button class="btn btn-sm rounded-pill px-3 fw-bold @(chartType == "line" ? "btn-primary" : "btn-light text-muted")"
                        @onclick='() => ChangeChartType("line")'>
                    üìâ ƒê∆∞·ªùng
                </button>
            </div>

            <div class="btn-group shadow-sm bg-white rounded-pill p-1">
                <button class="btn btn-sm rounded-pill px-3 @(viewMode == "day" ? "btn-dark" : "btn-white text-muted")"
                        @onclick='() => ChangeView("day")'>
                    Ng√†y
                </button>
                <button class="btn btn-sm rounded-pill px-3 @(viewMode == "month" ? "btn-dark" : "btn-white text-muted")"
                        @onclick='() => ChangeView("month")'>
                    Th√°ng
                </button>
                <button class="btn btn-sm rounded-pill px-3 @(viewMode == "year" ? "btn-dark" : "btn-white text-muted")"
                        @onclick='() => ChangeView("year")'>
                    NƒÉm
                </button>
                <button class="btn btn-sm rounded-pill px-3 @(viewMode == "custom" ? "btn-dark" : "btn-white text-muted")"
                        @onclick='() => ChangeView("custom")'>
                    T√πy ch·ªânh
                </button>
            </div>
        </div>
    </div>

    <div class="card shadow-lg border-0 mb-4" style="border-radius: 16px; overflow: hidden;">
        <div class="card-body p-4 bg-white">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-uppercase text-secondary fw-bold" style="letter-spacing: 1px; font-size: 12px;">
                    Bi·ªÉu ƒë·ªì ho·∫°t ƒë·ªông (@GetCurrentModeName())
                </h6>

                <div class="d-flex gap-4">
                    <div class="d-flex align-items-center">
                        <span class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: #3b82f6;"></span>
                        <span class="fw-bold text-secondary" style="font-size: 13px;">Nh·∫≠p kho</span>
                    </div>

                    <div class="d-flex align-items-center">
                        <span class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: #ef4444;"></span>
                        <span class="fw-bold text-secondary" style="font-size: 13px;">Xu·∫•t kho</span>
                    </div>
                </div>
            </div>

            <div style="height: 450px;">
                <canvas id="inventoryChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100" style="border-radius: 16px;">
                <div class="card-body">
                    <h6 class="fw-bold text-dark mb-3">üèÜ Top 5 S·∫£n Ph·∫©m Ti√™u Bi·ªÉu</h6>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="bg-light text-secondary small">
                                <tr>
                                    <th class="border-0 rounded-start">S·∫£n ph·∫©m</th>
                                    <th class="border-0 text-center">S·ªë l∆∞·ª£ng</th>
                                    <th class="border-0 text-end rounded-end">Doanh thu</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var prod in topProducts)
                                {
                                    <tr>
                                        <td class="fw-bold text-dark">@prod.Name</td>
                                        <td class="text-center"><span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">@prod.Quantity</span></td>
                                        <td class="text-end fw-bold text-success">@prod.Revenue.ToString("N0") ‚Ç´</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100" style="border-radius: 16px;">
                <div class="card-body">
                    <h6 class="fw-bold text-dark mb-3">üç∞ T·ª∑ L·ªá Danh M·ª•c</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="p-4 rounded-4 text-white shadow" style="background-color: #3b82f6;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-1 opacity-75 fw-bold text-uppercase small">T·ªïng Nh·∫≠p Kho</p>
                        <h2 class="fw-bold mb-0">@TotalImport.ToString("N0") <span class="fs-6">SP</span></h2>
                    </div>
                    <div class="fs-1 opacity-50">üì•</div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="p-4 rounded-4 text-white shadow" style="background-color: #ef4444;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-1 opacity-75 fw-bold text-uppercase small">T·ªïng Xu·∫•t Kho</p>
                        <h2 class="fw-bold mb-0">@TotalExport.ToString("N0") <span class="fs-6">SP</span></h2>
                    </div>
                    <div class="fs-1 opacity-50">üì§</div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string viewMode = "month";
    private string chartType = "line";
    private double TotalImport = 0;
    private double TotalExport = 0;
    private DateTime fromDate = DateTime.Now.AddDays(-30);
    private DateTime toDate = DateTime.Now;
    public class ProductInfo
    {
        public string Name { get; set; } = "";
        public int Quantity { get; set; }
        public double Revenue { get; set; }
    }

    private List<ProductInfo> topProducts = new();
    protected override void OnInitialized()
    {
        topProducts = new List<ProductInfo>
        {
            new ProductInfo { Name = "iPhone 15 Pro", Quantity = 120, Revenue = 3600000000 },
            new ProductInfo { Name = "Samsung S24", Quantity = 95, Revenue = 2800000000 },
            new ProductInfo { Name = "MacBook M2", Quantity = 80, Revenue = 2000000000 },
            new ProductInfo { Name = "Sony XM5", Quantity = 150, Revenue = 1050000000 },
            new ProductInfo { Name = "iPad Gen 10", Quantity = 200, Revenue = 1800000000 }
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await RenderChart();
        if (firstRender || viewMode != "")
        {
            await RenderPieChart();
        }
    }

    private async Task ChangeView(string mode)
    {
        viewMode = mode;
        StateHasChanged();
        await RenderChart();
    }

    private async Task ChangeChartType(string type)
    {
        chartType = type;
        await RenderChart();
    }

    private async Task LoadCustomData()
    {
        await RenderChart();
    }

    private string GetCurrentModeName() => viewMode switch
    {
        "day" => "7 ng√†y g·∫ßn nh·∫•t",
        "month" => "12 th√°ng",
        "year" => "5 nƒÉm",
        "custom" => $"{fromDate:dd/MM} - {toDate:dd/MM}",
        _ => ""
    };

    private async Task ExportToExcel()
    {
        var (labels, dataImport, dataExport) = GetDataByMode(viewMode);

        var csv = "ThoiGian,NhapKho,XuatKho\n";
        for (int i = 0; i < labels.Length; i++)
        {
            csv += $"{labels[i]},{dataImport[i]},{dataExport[i]}\n";
        }

        await JS.InvokeVoidAsync("downloadFile", $"BaoCao_{DateTime.Now:yyyyMMdd_HHmmss}.csv", csv);
    }

    private async Task RenderChart()
    {
        var (labels, dataImport, dataExport) = GetDataByMode(viewMode);
        TotalImport = dataImport.Sum();
        TotalExport = dataExport.Sum();

        bool isLine = chartType == "line";

        var config = new
        {
            type = chartType,
            data = new
            {
                labels = labels,
                datasets = new[]
                {
                    new {
                        label = "Nh·∫≠p kho",
                        data = dataImport,
                        fill = isLine,
                        tension = 0.4,
                        pointRadius = isLine ? 4 : 0,
                        backgroundColor = isLine ? "rgba(59, 130, 246, 0.2)" : "#3b82f6",
                        borderColor = "#3b82f6",
                        borderWidth = 2,
                        borderRadius = 4
                    },
                    new {
                        label = "Xu·∫•t kho",
                        data = dataExport,
                        fill = isLine,
                        tension = 0.4,
                        pointRadius = isLine ? 4 : 0,
                        backgroundColor = isLine ? "rgba(239, 68, 68, 0.2)" : "#ef4444",
                        borderColor = "#ef4444",
                        borderWidth = 2,
                        borderRadius = 4
                    }
                }
            },
            options = new
            {
                responsive = true,
                maintainAspectRatio = false,
                plugins = new { legend = new { display = false } },
                interaction = new { mode = "index", intersect = false },
                scales = new
                {
                    y = new { beginAtZero = true, grid = new { color = "#f3f4f6" }, border = new { display = false } },
                    x = new { grid = new { display = false }, border = new { display = false } }
                }
            }
        };

        await JS.InvokeVoidAsync("setupChart", "inventoryChart", config);
    }

    private async Task RenderPieChart()
    {
        var config = new
        {
            type = "doughnut",
            data = new
            {
                labels = new[] { "ƒêi·ªán t·ª≠", "Gia d·ª•ng", "Th·ªùi trang", "Kh√°c" },
                datasets = new[]
                {
                    new {
                        data = new[] { 40, 25, 20, 15 },
                        backgroundColor = new[] { "#3b82f6", "#10b981", "#f59e0b", "#9ca3af" },
                        borderWidth = 0,
                        hoverOffset = 4
                    }
                }
            },
            options = new
            {
                responsive = true,
                maintainAspectRatio = false,
                plugins = new { legend = new { position = "right" } },
                cutout = "75%"
            }
        };

        await JS.InvokeVoidAsync("setupPieChart", "categoryChart", config);
    }

    private (string[], double[], double[]) GetDataByMode(string mode)
    {
        if (mode == "day") return (new[] { "T2", "T3", "T4", "T5", "T6", "T7", "CN" }, new double[] { 50, 20, 15, 40, 60, 10, 5 }, new double[] { 30, 25, 10, 20, 45, 15, 8 });
        else if (mode == "year") return (new[] { "2021", "2022", "2023", "2024", "2025" }, new double[] { 5000, 6000, 4500, 7000, 8000 }, new double[] { 4800, 5500, 4000, 6800, 7200 });
        else if (mode == "custom") return (new[] { "Tu·∫ßn 1", "Tu·∫ßn 2", "Tu·∫ßn 3", "Tu·∫ßn 4" }, new double[] { 100, 120, 90, 110 }, new double[] { 80, 100, 150, 90 });
        else return (new[] { "Th√°ng 1", "Th√°ng 2", "Th√°ng 3", "Th√°ng 4", "Th√°ng 5", "Th√°ng 6", "Th√°ng 7", "Th√°ng 8", "Th√°ng 9", "Th√°ng 10", "Th√°ng 11", "Th√°ng 12" }, new double[] { 120, 150, 180, 200, 170, 160, 210, 240, 200, 180, 220, 300 }, new double[] { 100, 130, 160, 190, 150, 140, 190, 220, 180, 170, 200, 280 });
    }
}