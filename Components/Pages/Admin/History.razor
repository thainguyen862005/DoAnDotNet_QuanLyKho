@page "/admin/history"
@layout AdminLayout
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using QuanLyKho.Data
@inject AppDbContext _context

<PageTitle>Lịch sử nhập / xuất kho</PageTitle>

<div class="container-fluid px-4">

    <div class="mt-4 mb-4">
        <h2 class="fw-bold mb-0">Lịch sử nhập / xuất kho</h2>
        <p class="text-muted">Theo dõi các thao tác kho (Admin)</p>
    </div>

    <!-- BỘ LỌC -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-2 align-items-center">

                <div class="col-md-4">
                    <input class="form-control"
                           placeholder="Tìm theo mã sản phẩm..."
                           @bind="SearchTerm"
                           @bind:event="oninput" />
                </div>

                <div class="col-md-2">
                    <select class="form-select" @bind="TypeFilter">
                        <option value="">Tất cả</option>
                        <option value="Nhập">Nhập</option>
                        <option value="Xuất">Xuất</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <input type="date" class="form-control" @bind="FromDate" />
                </div>

                <div class="col-md-2">
                    <input type="date" class="form-control" @bind="ToDate" />
                </div>

            </div>
        </div>
    </div>

    <!-- BẢNG LỊCH SỬ -->
    <div class="card border-0 shadow-sm overflow-hidden">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr class="text-uppercase text-secondary small fw-bold">
                    <th class="ps-4">Ngày</th>
                    <th>Mã sản phẩm</th>
                    <th>Trạng Thái</th>
                    <th class="text-center">Số lượng</th>
                    <th>Nhân viên</th>
                    <th>Phiếu</th>
                </tr>
            </thead>
            <tbody>
                @if (FilteredLogs.Any())
                {
                    @foreach (var h in FilteredLogs)
                    {
                        <tr>
                            <td class="ps-4">
                                @h.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                            </td>
                            <td class="fw-bold">@h.SKU</td>
                            <td>
                                <span class="badge rounded-pill px-3 py-2 @GetTypeBadge(h.Type)">
                                    @h.Type
                                </span>
                            </td>
                            <td class="text-center fw-bold">
                                <span class="@(h.Type == "Nhập" ? "text-success" : "text-danger")">
                                    @(h.Type == "Nhập" ? "+" : "-")@h.Quantity
                                </span>
                            </td>
                            <td>@h.StaffName</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary"
                                        @onclick="() => XemPhieu(h)">
                                    @h.ReceiptCode
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            Không có dữ liệu
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (showReceiptModal && selectedLog != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Chi tiết phiếu kho</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="DongModal"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            @if (!string.IsNullOrEmpty(receiptImageUrl))
                            {
                                <img src="@receiptImageUrl" class="img-fluid rounded shadow-sm" />
                            }
                            else
                            {
                                <div class="text-muted">Không có ảnh</div>
                            }
                        </div>

                        <div class="col-md-8">
                            <p><b>Mã phiếu:</b> @selectedLog.ReceiptCode</p>
                            <p><b>Ngày:</b> @selectedLog.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                            <hr />
                            <p><b>Tên sản phẩm:</b> @receiptProductName</p>
                            <p><b>Mã sản phẩm:</b> @selectedLog.SKU</p>
                            <p><b>Loại:</b> @selectedLog.Type</p>
                            <p><b>Số lượng:</b> @selectedLog.Quantity</p>
                            <p><b>Nhân viên:</b> @selectedLog.StaffName</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" @onclick="DongModal">OK</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string SearchTerm = "";
    private string TypeFilter = "";
    private DateTime? FromDate;
    private DateTime? ToDate;

    private bool showReceiptModal = false;
    private HistoryViewModel? selectedLog;
    private string? receiptImageUrl;
    private string? receiptProductName;

    private List<HistoryViewModel> logs = new();

    protected override void OnInitialized()
    {
        logs = _context.TransactionDetails
            .Include(d => d.Transaction)
                .ThenInclude(t => t.User)
            .Include(d => d.ProductItem)
                .ThenInclude(i => i.Product)
            .Select(d => new HistoryViewModel
            {
                TransactionId = d.TransactionID,
                SpItemId = d.Sp_item_ID,
                CreatedAt = d.Transaction.TransactionDate,
                SKU = d.ProductItem.SKU ?? "",
                Type = d.Transaction.Type ?? "",
                Quantity = d.Quantity,
                StaffName = d.Transaction.User.Username,
                ReceiptCode = "RC" + d.TransactionID + d.Transaction.TransactionDate.ToString("ddMMyy")
            })
            .OrderByDescending(x => x.CreatedAt)
            .ToList();
    }

    private IEnumerable<HistoryViewModel> FilteredLogs =>
        logs.Where(h =>
            (string.IsNullOrWhiteSpace(SearchTerm) || h.SKU.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrWhiteSpace(TypeFilter) || h.Type == TypeFilter) &&
            (!FromDate.HasValue || h.CreatedAt.Date >= FromDate.Value) &&
            (!ToDate.HasValue || h.CreatedAt.Date <= ToDate.Value)
        );

    private string GetTypeBadge(string type) => type switch
    {
        "Nhập" => "bg-success-subtle text-success",
        "Xuất" => "bg-danger-subtle text-danger",
        _ => "bg-secondary text-white"
    };

    private void XemPhieu(HistoryViewModel log)
    {
        selectedLog = log;

        var item = _context.ProductItems
            .Include(i => i.Product)
            .FirstOrDefault(i => i.Sp_item_id == log.SpItemId);

        if (item != null)
        {
            receiptImageUrl = item.Product.ImageUrl;
            receiptProductName = item.Product.Sp_name;
        }
        else
        {
            receiptImageUrl = null;
            receiptProductName = "Không tìm thấy sản phẩm";
        }

        showReceiptModal = true;
    }

    private void DongModal()
    {
        showReceiptModal = false;
        selectedLog = null;
        receiptImageUrl = null;
        receiptProductName = null;
    }

    public class HistoryViewModel
    {
        public DateTime CreatedAt { get; set; }
        public string SKU { get; set; } = "";
        public string Type { get; set; } = "";
        public int Quantity { get; set; }
        public string StaffName { get; set; } = "";
        public string ReceiptCode { get; set; } = "";
        public int TransactionId { get; set; }
        public int SpItemId { get; set; }
    }
}