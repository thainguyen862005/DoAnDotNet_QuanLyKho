@page "/admin/history"
@layout AdminLayout
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using QuanLyKho.Data
@inject AppDbContext _context

<PageTitle>Lịch sử nhập / xuất kho</PageTitle>

<div class="container-fluid px-4">

    <div class="mt-4 mb-4">
        <h2 class="fw-bold mb-0">Lịch sử nhập / xuất kho</h2>
        <p class="text-muted">Theo dõi các thao tác kho (Admin)</p>
    </div>

    <!-- THANH TÌM KIẾM + LỌC LOẠI -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-8">
                    <input class="form-control"
                           placeholder="Tìm theo tên nhân viên..."
                           @bind="StaffSearch"
                           @bind:event="oninput" />
                </div>
                <div class="col-md-4">
                    <select class="form-select" @bind="TypeFilter">
                        <option value="">Tất cả loại</option>
                        <option value="Nhập">Nhập kho</option>
                        <option value="Xuất">Xuất kho</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- BẢNG CÓ SCROLL -->
    <div class="card border-0 shadow-sm">
        <div style="max-height: 500px; overflow-y: auto;">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light sticky-top">
                    <tr class="text-uppercase text-secondary small fw-bold">
                        <th class="ps-4">Ngày</th>
                        <th>Mã phiếu</th>
                        <th>Loại</th>
                        <th>Nhà cung cấp</th>
                        <th>Nhân viên</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @if (FilteredLogs.Any())
                    {
                        @foreach (var h in FilteredLogs)
                        {
                            <tr>
                                <td class="ps-4">@h.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td class="fw-bold text-primary">@h.ReceiptCode</td>
                                <td>
                                    <span class="badge rounded-pill px-3 py-2 @GetTypeBadge(h.Type)">
                                        @h.Type
                                    </span>
                                </td>
                                <td>
                                    @(h.Type == "Nhập" ? h.SupplierName : "---")
                                </td>
                                <td>@h.StaffName</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary"
                                            @onclick="() => XemPhieu(h)">
                                        Xem phiếu
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                Không có dữ liệu
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL CHI TIẾT PHIẾU -->
@if (showReceiptModal && selectedLog != null)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Chi tiết phiếu kho - @selectedLog.ReceiptCode</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="DongModal"></button>
                </div>

                <div class="modal-body">
                    <p><b>Ngày:</b> @selectedLog.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                    <p><b>Nhân viên:</b> @selectedLog.StaffName</p>

                    @if (selectedLog.Type == "Nhập")
                    {
                        <hr />
                        <p><b>Sản phẩm:</b> @receiptDetails.First().ProductName</p>
                        <p><b>SKU:</b> @receiptDetails.First().SKU</p>
                        <p><b>Số lượng:</b> @receiptDetails.First().Quantity</p>
                        <p><b>Giá nhập:</b> @receiptDetails.First().Price.ToString("N0") đ</p>
                        <p><b>Nhà cung cấp:</b> @selectedLog.SupplierName</p>
                    }
                    else
                    {
                        <table class="table table-bordered mt-3">
                            <thead class="table-light">
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th>SKU</th>
                                    <th class="text-center">SL</th>
                                    <th class="text-end">Đơn giá</th>
                                    <th class="text-end">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in receiptDetails)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td>@item.SKU</td>
                                        <td class="text-center">@item.Quantity</td>
                                        <td class="text-end">@item.Price.ToString("N0") đ</td>
                                        <td class="text-end">@((item.Price * item.Quantity).ToString("N0")) đ</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="DongModal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string StaffSearch = "";
    private string TypeFilter = "";
    private bool showReceiptModal = false;
    private HistoryViewModel? selectedLog;
    private List<ReceiptDetailVM> receiptDetails = new();
    private List<HistoryViewModel> logs = new();

    protected override void OnInitialized()
    {
        logs = _context.InventoryTransactions
            .Include(t => t.User)
            .Include(t => t.Supplier)
            .OrderByDescending(t => t.TransactionDate)
            .Select(t => new HistoryViewModel
            {
                TransactionId = t.TransactionID,
                CreatedAt = t.TransactionDate,
                Type = t.Type ?? "",
                StaffName = t.User != null
                            ? (t.User.Username ?? t.User.Username ?? "Admin")
                            : "Admin",
                SupplierName = t.Supplier != null ? t.Supplier.SupplierName : "",
                ReceiptCode = "PN-" + t.TransactionID.ToString("0000")
            })
            .ToList();
    }


    private IEnumerable<HistoryViewModel> FilteredLogs =>
    logs.Where(h =>
        (string.IsNullOrWhiteSpace(StaffSearch) ||
         h.StaffName.Contains(StaffSearch.Trim(), StringComparison.OrdinalIgnoreCase)) &&
        (string.IsNullOrWhiteSpace(TypeFilter) || h.Type == TypeFilter)
    );


    private void XemPhieu(HistoryViewModel log)
    {
        selectedLog = log;

        receiptDetails = _context.TransactionDetails
            .Where(d => d.TransactionID == log.TransactionId)
            .Include(d => d.ProductItem)
                .ThenInclude(i => i.Product)
            .Select(d => new ReceiptDetailVM
            {
                ProductName = d.ProductItem.Product.Sp_name,
                SKU = d.ProductItem.SKU,
                Quantity = d.Quantity,
                Price = d.UnitPrice
            }).ToList();

        showReceiptModal = true;
    }

    private void DongModal()
    {
        showReceiptModal = false;
        receiptDetails.Clear();
    }

    private string GetTypeBadge(string type) => type == "Nhập"
        ? "bg-success-subtle text-success"
        : "bg-danger-subtle text-danger";

    public class HistoryViewModel
    {
        public int TransactionId { get; set; }
        public DateTime CreatedAt { get; set; }
        public string Type { get; set; } = "";
        public string StaffName { get; set; } = "";
        public string SupplierName { get; set; } = "";
        public string ReceiptCode { get; set; } = "";
    }

    public class ReceiptDetailVM
    {
        public string ProductName { get; set; } = "";
        public string SKU { get; set; } = "";
        public int Quantity { get; set; }
        public decimal Price { get; set; }
    }
}