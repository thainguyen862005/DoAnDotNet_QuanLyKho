@page "/admin/dashboard"
@layout Components.Layout.AdminLayout
@rendermode InteractiveServer

@using Microsoft.JSInterop
@using System.Collections.Generic
@using System.Linq
@using Microsoft.EntityFrameworkCore
@using QuanLyKho.Data
@using QuanLyKho.Models
@using System.Text

@inject IJSRuntime JS
@inject AppDbContext Db

<PageTitle>Dashboard T·ªïng Quan</PageTitle>

<div class="container-fluid p-4" style="background-color: #f8f9fc;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark mb-1">Dashboard T·ªïng Quan</h3>
            <p class="text-muted mb-0">Theo d√µi kho h√†ng v√† hi·ªáu qu·∫£ kinh doanh.</p>
        </div>
        <div class="d-flex gap-2">
            <div class="bg-white px-3 py-2 rounded shadow-sm border d-flex align-items-center">
                <i class="bi bi-calendar-event me-2 text-muted"></i>
                <span class="fw-bold text-dark">@DateTime.Now.ToString("dd/MM/yyyy")</span>
            </div>
            <button class="btn btn-success shadow-sm fw-bold d-flex align-items-center" @onclick="ExportReport">
                <i class="bi bi-file-earmark-spreadsheet-fill me-2"></i> Xu·∫•t B√°o C√°o
            </button>
        </div>
    </div>

    <h6 class="text-uppercase text-secondary fw-bold small mb-3">üí∞ Hi·ªáu qu·∫£ kinh doanh</h6>
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card text-white shadow-sm border-0 h-100" style="background-color: #2563eb; border-radius: 12px;">
                <div class="card-body p-4 position-relative overflow-hidden">
                    <h6 class="opacity-75 mb-2">T·ªïng Doanh Thu</h6>
                    <h3 class="fw-bold mb-0">@TotalRevenue.ToString("N0") <small>ƒë</small></h3>
                    <i class="bi bi-currency-dollar position-absolute top-50 end-0 translate-middle-y me-3 opacity-25" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-white shadow-sm border-0 h-100" style="background-color: #059669; border-radius: 12px;">
                <div class="card-body p-4 position-relative overflow-hidden">
                    <h6 class="opacity-75 mb-2">T·ªïng L·ª£i Nhu·∫≠n (∆Ø·ªõc t√≠nh)</h6>
                    <h3 class="fw-bold mb-0">@TotalProfit.ToString("N0") <small>ƒë</small></h3>
                    <i class="bi bi-graph-up-arrow position-absolute top-50 end-0 translate-middle-y me-3 opacity-25" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-white shadow-sm border-0 h-100" style="background-color: #d97706; border-radius: 12px;">
                <div class="card-body p-4 position-relative overflow-hidden">
                    <h6 class="opacity-75 mb-2">T·ªïng ƒê∆°n H√†ng</h6>
                    <h3 class="fw-bold mb-0">@TotalOrders <small>ƒë∆°n</small></h3>
                    <i class="bi bi-receipt position-absolute top-50 end-0 translate-middle-y me-3 opacity-25" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>

    <h6 class="text-uppercase text-secondary fw-bold small mb-3">üì¶ T√¨nh tr·∫°ng kho</h6>
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card bg-white shadow-sm border-0 h-100 stats-card" style="border-left: 4px solid #3b82f6;">
                <div class="card-body p-4 d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted text-uppercase small fw-bold mb-1">T·ªïng s·∫£n ph·∫©m</h6>
                        <h3 class="fw-bold text-dark mb-0">@TotalProducts</h3>
                    </div>
                    <div class="icon-circle bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-box-seam"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-white shadow-sm border-0 h-100 stats-card" style="border-left: 4px solid #10b981;">
                <div class="card-body p-4 d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted text-uppercase small fw-bold mb-1">V·ªën t·ªìn kho</h6>
                        <h3 class="fw-bold text-dark mb-0">@InventoryValue.ToString("N0")<small class="fs-6">ƒë</small></h3>
                    </div>
                    <div class="icon-circle bg-success bg-opacity-10 text-success">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-white shadow-sm border-0 h-100 stats-card" style="border-left: 4px solid #ef4444;">
                <div class="card-body p-4 d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted text-uppercase small fw-bold mb-1">C·∫ßn nh·∫≠p h√†ng</h6>
                        <h3 class="fw-bold text-danger mb-0">@LowStockCount</h3>
                    </div>
                    <div class="icon-circle bg-danger bg-opacity-10 text-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 h-100 rounded-4">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="fw-bold text-dark m-0">üèÜ Hi·ªáu qu·∫£ kinh doanh theo s·∫£n ph·∫©m</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="ps-4 py-3">S·∫£n ph·∫©m</th>
                                    <th class="text-center">ƒê√£ b√°n</th>
                                    <th class="text-end">Doanh thu</th>
                                    <th class="text-end pe-4">L·ª£i nhu·∫≠n</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (topProducts.Any())
                                {
                                    @foreach (var prod in topProducts)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="fw-bold text-primary">@prod.Name</span>
                                            </td>
                                            <td class="text-center fw-bold text-dark">@prod.SoldQuantity</td>
                                            <td class="text-muted text-end">@prod.Revenue.ToString("N0")</td>
                                            <td class="text-success fw-bold text-end pe-4">@prod.Profit.ToString("N0")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="4" class="text-center py-4 text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu b√°n h√†ng.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100 rounded-4">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="fw-bold text-dark m-0">üìä Bi·ªÉu ƒë·ªì nh·∫≠p/xu·∫•t (7 ng√†y)</h6>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas @ref="chartRef"></canvas>
                    </div>
                    <div class="mt-3 d-flex justify-content-center gap-3 small">
                        <span class="d-flex align-items-center"><i class="bi bi-square-fill text-primary me-2"></i> Nh·∫≠p</span>
                        <span class="d-flex align-items-center"><i class="bi bi-square-fill text-danger me-2"></i> Xu·∫•t</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .stats-card {
        border-radius: 12px;
        transition: transform 0.2s;
    }

        .stats-card:hover {
            transform: translateY(-2px);
        }

    .icon-circle {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .table thead th {
        font-weight: 600;
        letter-spacing: 0.5px;
    }
</style>

@code {
    private ElementReference chartRef;

    // --- Bi·∫øn d·ªØ li·ªáu ---
    private decimal TotalRevenue = 0;
    private decimal TotalProfit = 0;
    private int TotalOrders = 0;
    private int TotalProducts = 0;
    private decimal InventoryValue = 0;
    private int LowStockCount = 0;

    private List<ProductPerformanceModel> topProducts = new();

    public class ProductPerformanceModel
    {
        public string Name { get; set; } = "";
        public int SoldQuantity { get; set; }
        public decimal Revenue { get; set; }
        public decimal Profit { get; set; }
    }

    protected override void OnInitialized()
    {
        LoadDashboardData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RenderChart();
        }
    }

    private void LoadDashboardData()
    {
        // 1. T·ªïng quan Doanh thu & ƒê∆°n h√†ng (T·ª´ b·∫£ng Orders)
        var orders = Db.Orders.ToList();
        TotalRevenue = orders.Sum(o => o.TotalAmount);
        TotalOrders = orders.Count;

        TotalProfit = TotalRevenue * 0.15m;

        // 2. T√¨nh tr·∫°ng kho (T·ª´ b·∫£ng ProductItems)
        var items = Db.ProductItems.Include(x => x.Product).ToList();
        TotalProducts = items.Count;

        InventoryValue = items.Sum(i => i.StockQuantity * i.Price);

        LowStockCount = items.Count(i => i.StockQuantity < 5);

        // 3. Top S·∫£n ph·∫©m
        topProducts = orders
            .GroupBy(o => o.ProductName)
            .Select(g => new ProductPerformanceModel
            {
                Name = g.Key,
                SoldQuantity = g.Sum(x => x.Quantity),
                Revenue = g.Sum(x => x.TotalAmount),
                Profit = g.Sum(x => x.TotalAmount) * 0.15m
            })
            .OrderByDescending(x => x.Revenue)
            .Take(5)
            .ToList();
    }

    private async Task RenderChart()
    {
        var endDate = DateTime.Now.Date;
        var startDate = endDate.AddDays(-6);

        var dateLabels = new string[7];
        var dataImport = new double[7];
        var dataExport = new double[7];

        var transactions = Db.InventoryTransactions
            .Include(t => t.Details)
            .Where(t => t.TransactionDate >= startDate)
            .ToList();

        for (int i = 0; i < 7; i++)
        {
            var date = startDate.AddDays(i);
            dateLabels[i] = date.ToString("dd/MM");

            dataImport[i] = transactions
                .Where(t => t.TransactionDate.Date == date && t.Type == "Nh·∫≠p")
                .SelectMany(t => t.Details).Sum(d => d.Quantity);

            dataExport[i] = transactions
                .Where(t => t.TransactionDate.Date == date && t.Type == "Xu·∫•t")
                .SelectMany(t => t.Details).Sum(d => d.Quantity);
        }

        // C·∫§U H√åNH CHART (ƒê√É S·ª¨A L·ªñI C√ö PH√ÅP)
        var config = new
        {
            type = "bar",
            data = new
            {
                labels = dateLabels,
                datasets = new[]
                {
                    new {
                        label = "Nh·∫≠p",
                        data = dataImport,
                        backgroundColor = "#3b82f6",
                        borderRadius = 4,
                        barPercentage = 0.6
                    },
                    new {
                        label = "Xu·∫•t",
                        data = dataExport,
                        backgroundColor = "#ef4444",
                        borderRadius = 4,
                        barPercentage = 0.6
                    }
                }
            },
            options = new
            {
                responsive = true,
                maintainAspectRatio = false,
                plugins = new { legend = new { display = false } },
                scales = new
                {
                    // S·ª¨A L·ªñI ·ªû ƒê√ÇY: Th√™m t·ª´ kh√≥a 'new' cho grid
                    y = new { beginAtZero = true, grid = new { color = "#f3f4f6" } },
                    x = new { grid = new { display = false } }
                }
            }
        };

        await JS.InvokeVoidAsync("setupChart", chartRef, config);
    }

    private async Task ExportReport()
    {
        var sb = new StringBuilder();
        sb.Append("\uFEFF");

        sb.AppendLine("BAO CAO TONG QUAN KHO HANG");
        sb.AppendLine($"Ngay xuat: {DateTime.Now:dd/MM/yyyy HH:mm}");
        sb.AppendLine("");

        sb.AppendLine("I. TONG QUAN KINH DOANH");
        sb.AppendLine($"Tong Doanh Thu,{TotalRevenue}");
        sb.AppendLine($"Tong Loi Nhuan (Est),{TotalProfit}");
        sb.AppendLine($"Tong Don Hang,{TotalOrders}");
        sb.AppendLine($"Von Ton Kho,{InventoryValue}");
        sb.AppendLine("");

        sb.AppendLine("II. CHI TIET HIEU QUA SAN PHAM");
        sb.AppendLine("Ten San Pham,So Luong Ban,Doanh Thu,Loi Nhuan");

        foreach (var p in topProducts)
        {
            var cleanName = p.Name.Replace(",", " ");
            sb.AppendLine($"{cleanName},{p.SoldQuantity},{p.Revenue},{p.Profit}");
        }

        var fileName = $"BaoCao_Dashboard_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
        await JS.InvokeVoidAsync("downloadFile", fileName, sb.ToString());
    }
}