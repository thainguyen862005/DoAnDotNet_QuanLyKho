@page "/admin/dashboard"
@layout Components.Layout.AdminLayout
@rendermode InteractiveServer

@using Microsoft.JSInterop
@using System.Collections.Generic
@using System.Linq
@using Microsoft.EntityFrameworkCore
@using QuanLyKho.Data
@using QuanLyKho.Models
@using System.Globalization

@inject IJSRuntime JS
@inject AppDbContext Db

<PageTitle>Dashboard - T·ªïng quan (MySQL)</PageTitle>

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-0">Dashboard</h2>
            <p class="text-muted small mb-0">H·ªá th·ªëng qu·∫£n l√Ω kho (Database: MySQL)</p>
        </div>
        <button class="btn btn-sm btn-success shadow-sm fw-bold" @onclick="ExportToExcel">
            <i class="bi bi-download me-1"></i> Xu·∫•t B√°o C√°o
        </button>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-4 border-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                T·ªïng M√£ SKU
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@TotalProductItems.ToString("N0")</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-upc-scan fs-1 text-gray-300 opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-4 border-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                T·ªïng Nh·∫≠p Kho
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@TotalImportAllTime.ToString("N0")</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-arrow-down-circle fs-1 text-gray-300 opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-4 border-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-danger text-uppercase mb-1">
                                T·ªïng Xu·∫•t Kho
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@TotalExportAllTime.ToString("N0")</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-arrow-up-circle fs-1 text-gray-300 opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-4 border-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                S·∫Øp H·∫øt H√†ng 
                            </div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@LowStockCount</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-exclamation-triangle fs-1 text-gray-300 opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-white">
            <h6 class="m-0 fw-bold text-primary">
                <i class="bi bi-graph-up me-1"></i> Bi·ªÉu ƒê·ªì Nh·∫≠p/Xu·∫•t (@GetCurrentModeName())
            </h6>
            
            <div class="d-flex gap-2 align-items-center">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn @(viewMode == "day" ? "btn-primary" : "btn-outline-secondary")" @onclick='() => ChangeView("day")'>7 Ng√†y</button>
                    <button type="button" class="btn @(viewMode == "month" ? "btn-primary" : "btn-outline-secondary")" @onclick='() => ChangeView("month")'>12 Th√°ng</button>
                </div>
                
                <div class="dropdown no-arrow">
                    <button class="btn btn-sm btn-light border dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-gear-fill text-gray-400"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end shadow animated--fade-in">
                        <button class="dropdown-item @(chartType == "bar" ? "active" : "")" @onclick='() => ChangeChartType("bar")'>C·ªôt (Bar)</button>
                        <button class="dropdown-item @(chartType == "line" ? "active" : "")" @onclick='() => ChangeChartType("line")'>ƒê∆∞·ªùng (Line)</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="chart-area" style="height: 400px;">
                <canvas @ref="inventoryChartRef"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card shadow h-100">
                <div class="card-header py-3 bg-white">
                    <h6 class="m-0 fw-bold text-dark">üèÜ Top S·∫£n Ph·∫©m B√°n Ch·∫°y (Th√°ng @DateTime.Now.Month)</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="ps-4">S·∫£n ph·∫©m</th>
                                    <th class="text-center">S·ªë l∆∞·ª£ng xu·∫•t</th>
                                    <th class="text-end pe-4">Doanh thu</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (topProducts.Any())
                                {
                                    @foreach (var prod in topProducts)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <div class="d-flex align-items-center">
                                                    <div class="rounded-circle bg-light d-flex justify-content-center align-items-center me-3" style="width:40px;height:40px;">
                                                        <i class="bi bi-box text-primary"></i>
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold text-dark">@prod.Name</div>
                                                        <div class="small text-muted">SKU: @prod.Sku</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3">
                                                    @prod.Quantity
                                                </span>
                                            </td>
                                            <td class="text-end fw-bold text-success pe-4">
                                                @prod.Revenue.ToString("N0") ‚Ç´
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">Ch∆∞a c√≥ d·ªØ li·ªáu xu·∫•t kho trong th√°ng n√†y.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow h-100">
                <div class="card-header py-3 bg-white">
                    <h6 class="m-0 fw-bold text-dark">üç∞ T·ªìn Kho Theo H√£ng</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2" style="height: 250px; position: relative;">
                         @if(hasBrandData)
                        {
                            <canvas @ref="pieChartRef"></canvas>
                        }
                        else
                        {
                             <div class="d-flex justify-content-center align-items-center h-100 text-muted flex-column">
                                 <i class="bi bi-pie-chart fs-1 opacity-25"></i>
                                 <span class="mt-2">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
                             </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ElementReference inventoryChartRef;
    private ElementReference pieChartRef;

    private string viewMode = "day"; 
    private string chartType = "bar";
    
    // Bi·∫øn th·ªëng k√™
    private int TotalProductItems = 0;
    private long TotalImportAllTime = 0;
    private long TotalExportAllTime = 0;
    private int LowStockCount = 0;
    private bool hasBrandData = false;

    // ViewModel cho Top S·∫£n ph·∫©m
    public class ProductStatViewModel
    {
        public string Name { get; set; } = "";
        public string Sku { get; set; } = "";
        public int Quantity { get; set; }
        public decimal Revenue { get; set; }
    }

    private List<ProductStatViewModel> topProducts = new();

    protected override void OnInitialized()
    {
        LoadStats();
        LoadTopProducts();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAndRenderChart();
            await LoadAndRenderPieChart();
        }
    }

    // --- 1. L·∫•y s·ªë li·ªáu th·ªëng k√™ t·ªïng qu√°t ---
    private void LoadStats()
    {
        // ƒê·∫øm t·ªïng s·ªë d√≤ng trong b·∫£ng SP_item
        TotalProductItems = Db.ProductItems.Count();

        // T√≠nh t·ªïng nh·∫≠p: Join Transaction_detail v·ªõi Inventory_Transactions, l·ªçc Type = 'Nh·∫≠p'
        TotalImportAllTime = Db.TransactionDetails
            .Include(d => d.Transaction)
            .Where(d => d.Transaction.Type == "Nh·∫≠p")
            .Sum(d => (long)d.Quantity);

        // T√≠nh t·ªïng xu·∫•t
        TotalExportAllTime = Db.TransactionDetails
            .Include(d => d.Transaction)
            .Where(d => d.Transaction.Type == "Xu·∫•t")
            .Sum(d => (long)d.Quantity);

        // ƒê·∫øm s·∫£n ph·∫©m c√≥ StockQuantity < 5
        LowStockCount = Db.ProductItems.Count(p => p.StockQuantity < 5);
    }

    // --- 2. L·∫•y Top s·∫£n ph·∫©m b√°n ch·∫°y (Xu·∫•t kho) ---
    private void LoadTopProducts()
    {
        var currentMonth = DateTime.Now.Month;
        var currentYear = DateTime.Now.Year;

        // L∆∞u √Ω: V·ªõi MySQL, EF Core x·ª≠ l√Ω DateTime t·ªët, nh∆∞ng ƒë·ªÉ an to√†n nh·∫•t
        // ta n√™n l·∫•y d·ªØ li·ªáu th√¥ v·ªÅ r·ªìi group ·ªü client n·∫øu l∆∞·ª£ng d·ªØ li·ªáu ch∆∞a qu√° l·ªõn.
        // ·ªû ƒë√¢y t√¥i d√πng GroupBy tr·ª±c ti·∫øp tr√™n Database n·∫øu Provider h·ªó tr·ª£, 
        // ho·∫∑c ToList() tr∆∞·ªõc ƒë·ªÉ an to√†n.
        
        var rawData = Db.TransactionDetails
            .Include(d => d.Transaction)
            .Include(d => d.ProductItem)
                .ThenInclude(pi => pi.Product) // ƒê·ªÉ l·∫•y t√™n Sp_name
            .Where(d => d.Transaction.Type == "Xu·∫•t" 
                     && d.Transaction.TransactionDate.Month == currentMonth 
                     && d.Transaction.TransactionDate.Year == currentYear)
            .ToList(); 

        topProducts = rawData
            .GroupBy(d => d.Sp_item_ID)
            .Select(g => new ProductStatViewModel
            {
                // L·∫•y t√™n t·ª´ b·∫£ng Sp (Product) th√¥ng qua quan h·ªá
                Name = g.First().ProductItem?.Product?.Sp_name ?? "S·∫£n ph·∫©m ƒë√£ x√≥a",
                Sku = g.First().ProductItem?.SKU ?? "N/A",
                Quantity = g.Sum(x => x.Quantity),
                Revenue = g.Sum(x => x.Quantity * x.UnitPrice)
            })
            .OrderByDescending(x => x.Quantity)
            .Take(5)
            .ToList();
    }

    // --- 3. V·∫Ω Bi·ªÉu ƒë·ªì (Logic quan tr·ªçng) ---
    private async Task ChangeView(string mode)
    {
        viewMode = mode;
        StateHasChanged();
        await LoadAndRenderChart();
    }

    private async Task ChangeChartType(string type)
    {
        chartType = type;
        await LoadAndRenderChart();
    }

    private async Task LoadAndRenderChart()
    {
        string[] labels;
        double[] dataImport;
        double[] dataExport;

        var now = DateTime.Now;

        if (viewMode == "day") // 7 ng√†y g·∫ßn nh·∫•t
        {
            var startDate = now.Date.AddDays(-6);
            
            // T·∫°o danh s√°ch 7 ng√†y li√™n t·ª•c ƒë·ªÉ l√†m nh√£n (Label)
            var dateRange = Enumerable.Range(0, 7).Select(i => startDate.AddDays(i)).ToList();
            labels = dateRange.Select(d => d.ToString("dd/MM")).ToArray();

            // L·∫•y d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y
            // L∆∞u √Ω: TransactionDate l√† DATETIME trong MySQL
            var transactions = Db.InventoryTransactions
                .Include(t => t.Details)
                .Where(t => t.TransactionDate >= startDate && t.TransactionDate < now.Date.AddDays(1))
                .ToList();

            dataImport = new double[7];
            dataExport = new double[7];

            for (int i = 0; i < 7; i++)
            {
                var d = dateRange[i];
                // T√≠nh t·ªïng theo t·ª´ng ng√†y
                dataImport[i] = transactions
                    .Where(t => t.TransactionDate.Date == d && t.Type == "Nh·∫≠p")
                    .SelectMany(t => t.Details).Sum(x => x.Quantity);

                dataExport[i] = transactions
                    .Where(t => t.TransactionDate.Date == d && t.Type == "Xu·∫•t")
                    .SelectMany(t => t.Details).Sum(x => x.Quantity);
            }
        }
        else // month (12 th√°ng)
        {
            var startDate = new DateTime(now.Year, now.Month, 1).AddMonths(-11);
            var monthRange = Enumerable.Range(0, 12).Select(i => startDate.AddMonths(i)).ToList();
            labels = monthRange.Select(d => d.ToString("MM/yyyy")).ToArray();

            var transactions = Db.InventoryTransactions
                .Include(t => t.Details)
                .Where(t => t.TransactionDate >= startDate)
                .ToList();

            dataImport = new double[12];
            dataExport = new double[12];

            for (int i = 0; i < 12; i++)
            {
                var m = monthRange[i];
                dataImport[i] = transactions
                    .Where(t => t.TransactionDate.Month == m.Month && t.TransactionDate.Year == m.Year && t.Type == "Nh·∫≠p")
                    .SelectMany(t => t.Details).Sum(x => x.Quantity);
                
                dataExport[i] = transactions
                    .Where(t => t.TransactionDate.Month == m.Month && t.TransactionDate.Year == m.Year && t.Type == "Xu·∫•t")
                    .SelectMany(t => t.Details).Sum(x => x.Quantity);
            }
        }

        // C·∫•u h√¨nh Chart.js
        bool isLine = chartType == "line";
        var config = new
        {
            type = chartType,
            data = new
            {
                labels = labels,
                datasets = new[]
                {
                    new {
                        label = "Nh·∫≠p kho",
                        data = dataImport,
                        fill = isLine,
                        backgroundColor = isLine ? "rgba(78, 115, 223, 0.05)" : "#4e73df",
                        borderColor = "#4e73df",
                        borderWidth = 2,
                        borderRadius = 4,
                        tension = 0.3
                    },
                    new {
                        label = "Xu·∫•t kho",
                        data = dataExport,
                        fill = isLine,
                        backgroundColor = isLine ? "rgba(231, 74, 59, 0.05)" : "#e74a3b",
                        borderColor = "#e74a3b",
                        borderWidth = 2,
                        borderRadius = 4,
                        tension = 0.3
                    }
                }
            },
            options = new
            {
                responsive = true,
                maintainAspectRatio = false,
                plugins = new { legend = new { display = true, position = "top" } },
                scales = new
                {
                    y = new { beginAtZero = true, grid = new { color = "#eaecf4" } },
                    x = new { grid = new { display = false } }
                }
            }
        };

        await JS.InvokeVoidAsync("setupChart", inventoryChartRef, config);
    }

    // --- 4. V·∫Ω Bi·ªÉu ƒë·ªì tr√≤n (T·ªìn kho theo H√£ng) ---
    private async Task LoadAndRenderPieChart()
    {
        // Join: ProductItem -> Product -> Brand
        var brandStats = Db.ProductItems
            .Include(pi => pi.Product)
            .ThenInclude(p => p.Brand)
            .Where(pi => pi.Product.Brand != null)
            .GroupBy(pi => pi.Product.Brand.Brand_name) // Group theo t√™n h√£ng
            .Select(g => new { Brand = g.Key, Stock = g.Sum(x => x.StockQuantity) })
            .OrderByDescending(x => x.Stock)
            .Take(5)
            .ToList();

        if (brandStats.Any())
        {
            hasBrandData = true;
            var labels = brandStats.Select(x => x.Brand).ToArray();
            var data = brandStats.Select(x => x.Stock).ToArray();
            // M√†u s·∫Øc chu·∫©n Admin theme
            var colors = new[] { "#4e73df", "#1cc88a", "#36b9cc", "#f6c23e", "#e74a3b" };

            var config = new
            {
                type = "doughnut",
                data = new
                {
                    labels = labels,
                    datasets = new[]
                    {
                        new {
                            data = data,
                            backgroundColor = colors.Take(labels.Length).ToArray(),
                            hoverOffset = 4
                        }
                    }
                },
                options = new
                {
                    responsive = true,
                    maintainAspectRatio = false,
                    plugins = new { legend = new { position = "right" } },
                    cutout = "70%"
                }
            };
            await JS.InvokeVoidAsync("setupPieChart", pieChartRef, config);
        }
    }

    private string GetCurrentModeName() => viewMode == "day" ? "7 ng√†y g·∫ßn nh·∫•t" : "12 th√°ng qua";

    private async Task ExportToExcel()
    {
        await JS.InvokeVoidAsync("alert", "T√≠nh nƒÉng ƒëang c·∫≠p nh·∫≠t...");
    }
}