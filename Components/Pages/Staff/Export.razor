@page "/staff/export"
@layout Components.Layout.StaffLayout
@using QuanLyKho.Data
@using QuanLyKho.Services
@rendermode InteractiveServer

@inject AppDbContext Db
@inject UserSession Session
@inject NavigationManager Nav

<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-secondary">Xuất kho (Staff)</h3>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">@successMessage</div>
            }

            <div class="mb-3">
                <label class="form-label fw-bold">Mã sản phẩm (SKU) hoặc Tên:</label>
                <input class="form-control" @bind="searchTerm" placeholder="Nhập SKU hoặc tên để tìm..." />
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Số lượng xuất:</label>
                <input type="number" class="form-control" @bind="quantity" min="1" />
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Lý do xuất:</label>
                <textarea class="form-control" @bind="reason" placeholder="Ví dụ: Xuất bán lẻ, Xuất hủy..."></textarea>
            </div>

            <button class="btn btn-danger" @onclick="XuLyXuatKho">Xác nhận Xuất</button>
        </div>
    </div>
</div>

@code {
    private string searchTerm = "";
    private int quantity = 1;
    private string reason = "";
    private string errorMessage = "";
    private string successMessage = "";

    private void XuLyXuatKho()
    {
        errorMessage = "";
        successMessage = "";

        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            errorMessage = "Vui lòng nhập thông tin sản phẩm.";
            return;
        }

        // 1. Tìm sản phẩm
        var product = Db.Products.FirstOrDefault(p => p.SKU == searchTerm)
                   ?? Db.Products.FirstOrDefault(p => p.Name.Contains(searchTerm));

        if (product == null)
        {
            errorMessage = "Không tìm thấy sản phẩm này trong kho!";
            return;
        }

        // 2. Kiểm tra tồn kho
        if (product.Stock < quantity)
        {
            errorMessage = $"Không đủ hàng! Tồn kho hiện tại: {product.Stock}";
            return;
        }

        // 3. Trừ kho
        product.Stock -= quantity;

        // 4. Ghi lịch sử
        var log = new InventoryLog
        {
            ProductName = product.Name,
            SKU = product.SKU,
            Type = "Xuất",
            Quantity = quantity,
            StaffName = Session.CurrentUser?.Username ?? "Staff",
            Note = reason,
            CreatedAt = DateTime.Now
        };

        Db.InventoryLogs.Add(log);
        Db.SaveChanges();

        successMessage = $"Đã xuất {quantity} {product.Name}. Tồn kho còn lại: {product.Stock}";
        searchTerm = "";
        quantity = 1;
        reason = "";
    }
}