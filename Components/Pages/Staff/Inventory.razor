@page "/staff/inventory"
@layout StaffLayout
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using QuanLyKho.Data
@using QuanLyKho.Models

@inject NavigationManager Nav
@inject AppDbContext DbContext

<style>
    /* 1. Giới hạn chiều cao khung chứa bảng và bật thanh cuộn */
    .table-scroll-container {
        max-height: 600px; /* Bạn có thể chỉnh số này cao thấp tùy ý */
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    /* 2. Cố định tiêu đề bảng (Sticky Header) */
    .sticky-header th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa; /* Màu nền xám nhạt giống Bootstrap bg-light */
        z-index: 10; /* Đảm bảo nó nằm đè lên nội dung */
        box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Đổ bóng nhẹ ngăn cách header */
    }
</style>

<div class="container-fluid px-4">
    @* Header trang *@
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold mb-0 text-secondary">Tra cứu Tồn kho</h2>
            <p class="text-muted">Dữ liệu thực tế từ hệ thống</p>
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn btn-success shadow-sm fw-bold" @onclick="GoToImport">
                <i class="bi bi-box-arrow-in-down"></i> Nhập hàng
            </button>
            <button class="btn btn-danger shadow-sm fw-bold" @onclick="GoToExport">
                <i class="bi bi-box-arrow-up"></i> Xuất hàng
            </button>
        </div>
    </div>

    @* --- THANH CÔNG CỤ (TÌM KIẾM & LỌC) --- *@
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-2">
            <div class="row g-2">
                @* Tìm kiếm *@
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-0 text-muted ps-3">
                            <i class="bi bi-search"></i>
                        </span>
                        <input class="form-control border-0 shadow-none"
                               placeholder="Tìm theo tên, SKU..."
                               @bind="SearchTerm"
                               @bind:event="oninput" 
                               @onkeyup="HandleSearch" />
                    </div>
                </div>
                
                @* Lọc Hãng *@
                <div class="col-md-3">
                    <select class="form-select border-0 bg-light fw-bold text-secondary" @onchange="FilterByBrand">
                        <option value="0">-- Tất cả Hãng --</option>
                        @if (Brands != null)
                        {
                            @foreach (var brand in Brands)
                            {
                                <option value="@brand.Brand_Id">@brand.Brand_name</option>
                            }
                        }
                    </select>
                </div>
                
                @* Lọc Trạng thái *@
                <div class="col-md-3">
                    <select class="form-select border-0 bg-light fw-bold text-secondary" @onchange="FilterByStatus">
                        <option value="0">-- Tất cả Trạng thái --</option>
                        <option value="1" class="text-success">✅ Sẵn hàng</option>
                        <option value="2" class="text-danger">❌ Hết hàng</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    @* --- BẢNG DỮ LIỆU CÓ THANH CUỘN --- *@
    <div class="card border-0 shadow-sm overflow-hidden mb-4">
        <div class="table-scroll-container">
            <table class="table table-hover align-middle mb-0">
                <thead class="sticky-header">
                    <tr class="text-secondary small fw-bold text-uppercase">
                        <th class="ps-4 py-3">Sản phẩm</th>
                        <th>SKU</th>
                        <th>Hãng</th>
                        <th class="text-center">Tồn kho</th>
                        <th class="text-center">Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    @if (inventoryItems == null)
                    {
                        <tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>
                    }
                    else if (inventoryItems.Count == 0)
                    {
                        <tr><td colspan="5" class="text-center py-5 text-muted">Không tìm thấy dữ liệu</td></tr>
                    }
                    else
                    {
                        @foreach (var item in inventoryItems)
                        {
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold text-dark fs-6">@(item.Product?.Sp_name ?? "Lỗi tên SP")</div>
                                    <div class="d-flex gap-1 mt-1">
                                        @if(!string.IsNullOrEmpty(item.Storage)) { <span class="badge bg-light text-dark border">@item.Storage</span> }
                                        @if(!string.IsNullOrEmpty(item.Color)) { <span class="badge bg-light text-dark border">@item.Color</span> }
                                    </div>
                                </td>
                                <td class="text-muted font-monospace">@item.SKU</td>
                                <td>
                                    <span class="badge rounded-pill px-3 py-2 @GetBrandBadgeClass(item.Product?.Brand?.Brand_name)">
                                        @(item.Product?.Brand?.Brand_name ?? "-")
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="fw-bold fs-5 @(item.StockQuantity < 10 ? "text-danger" : "text-success")">
                                        @item.StockQuantity
                                    </span>
                                </td>
                                <td class="text-center">
                                    @if (item.StockQuantity > 0) 
                                    { 
                                        <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle px-3">Sẵn hàng</span> 
                                    }
                                    else 
                                    { 
                                        <span class="badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle px-3">Hết hàng</span> 
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
        
        <div class="card-footer bg-white border-0 py-3">
            <div class="text-muted small">
                Đang hiển thị <strong>@inventoryItems?.Count</strong> sản phẩm mới nhất.
            </div>
        </div>
    </div>
</div>

@code {
    private List<ProductItem>? inventoryItems;
    private List<Brand>? Brands;
    
    // Biến lọc
    private string SearchTerm = "";
    private int SelectedBrandId = 0;
    private int SelectedStatus = 0;

    protected override async Task OnInitializedAsync()
    {
        Brands = await DbContext.Brands.AsNoTracking().ToListAsync();
        await LoadData();
    }

    private void GoToImport() => Nav.NavigateTo("/staff/import");
    private void GoToExport() => Nav.NavigateTo("/staff/export");

    private async Task HandleSearch(KeyboardEventArgs e) => await LoadData();
    
    private async Task FilterByBrand(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int val)) { SelectedBrandId = val; await LoadData(); }
    }

    private async Task FilterByStatus(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int val)) { SelectedStatus = val; await LoadData(); }
    }

    private async Task LoadData()
    {
        var query = DbContext.ProductItems
            .Include(pi => pi.Product)
            .ThenInclude(p => p.Brand)
            .AsNoTracking()
            .AsQueryable();

        // 1. Áp dụng bộ lọc
        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            string k = SearchTerm.ToLower();
            query = query.Where(x => (x.SKU != null && x.SKU.ToLower().Contains(k)) || 
                                     (x.Product != null && x.Product.Sp_name != null && x.Product.Sp_name.ToLower().Contains(k)));
        }
        if (SelectedBrandId > 0) query = query.Where(x => x.Product != null && x.Product.Brands_id == SelectedBrandId);
        if (SelectedStatus == 1) query = query.Where(x => x.StockQuantity > 0);
        else if (SelectedStatus == 2) query = query.Where(x => x.StockQuantity <= 0);

        // 2. Lấy dữ liệu (Không dùng Skip nữa)
        // Lấy 200 dòng để đảm bảo bảng đủ dài cho thanh cuộn xuất hiện
        inventoryItems = await query
            .OrderByDescending(x => x.Sp_item_id)
            .Take(200) 
            .ToListAsync();
    }

    private string GetBrandBadgeClass(string? brandName)
    {
        if (string.IsNullOrEmpty(brandName)) return "bg-light text-dark border";
        return brandName.ToLower() switch
        {
            "apple" => "bg-dark text-white", "samsung" => "bg-primary text-white",
            "xiaomi" => "bg-warning text-dark", "oppo" => "bg-success text-white",
            "sony" => "bg-dark text-white", "dell" => "bg-info text-white",
            "asus" => "bg-danger text-white", _ => "bg-light text-dark border"
        };
    }
}