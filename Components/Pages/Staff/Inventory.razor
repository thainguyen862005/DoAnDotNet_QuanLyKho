@page "/staff/inventory"
@layout StaffLayout
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using QuanLyKho.Data
@using QuanLyKho.Models

@inject NavigationManager Nav
@inject AppDbContext DbContext

<div class="container-fluid px-4">
    @* --- Tiêu đề trang --- *@
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold mb-0 text-secondary">Tra cứu Tồn kho</h2>
            <p class="text-muted">Kiểm tra số lượng thực tế từ kho</p>
        </div>
    </div>

    @* --- THANH CÔNG CỤ: TÌM KIẾM & LỌC --- *@
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-2">
            <div class="row g-2">
                @* 1. Ô Tìm kiếm: Hỗ trợ tìm theo Tên hoặc SKU *@
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-0 text-muted ps-3">
                            <i class="bi bi-search"></i>
                        </span>
                        <input class="form-control border-0 shadow-none"
                               placeholder="Tìm theo tên SP, SKU..."
                               @bind="SearchTerm"
                               @bind:event="oninput" 
                               @onkeyup="HandleSearch" />
                    </div>
                </div>

                @* 2. Lọc theo Hãng: Load động từ Database *@
                <div class="col-md-3">
                    <select class="form-select border-0 bg-light fw-bold text-secondary" 
                            @onchange="FilterByBrand">
                        <option value="0">-- Tất cả Hãng --</option>
                        @if (Brands != null)
                        {
                            @foreach (var brand in Brands)
                            {
                                <option value="@brand.Brand_Id">@brand.Brand_name</option>
                            }
                        }
                    </select>
                </div>

                @* 3. Lọc theo Trạng thái: Sẵn hàng hoặc Hết hàng *@
                <div class="col-md-3">
                    <select class="form-select border-0 bg-light fw-bold text-secondary" 
                            @onchange="FilterByStatus">
                        <option value="0">-- Tất cả Trạng thái --</option>
                        <option value="1" class="text-success">✅ Sẵn hàng</option>
                        <option value="2" class="text-danger">❌ Hết hàng</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    @* --- BẢNG DỮ LIỆU --- *@
    <div class="card border-0 shadow-sm overflow-hidden flex-grow-1 d-flex flex-column" style="min-height: 0;">
        <div class="table-responsive flex-grow-1" style="overflow-y: auto; max-height: 65vh;">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light" style="position: sticky; top: 0; z-index: 1;">
                    <tr class="text-secondary small fw-bold text-uppercase">
                        <th class="ps-4 py-3">Sản phẩm</th>
                        <th>SKU</th>
                        <th>Hãng</th>
                        <th class="text-center">Tồn kho</th>
                        <th class="text-center">Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    @if (inventoryItems == null)
                    {
                        <tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>
                    }
                    else if (inventoryItems.Count == 0)
                    {
                        <tr><td colspan="5" class="text-center py-5 text-muted">Không tìm thấy sản phẩm nào.</td></tr>
                    }
                    else
                    {
                        @foreach (var item in inventoryItems)
                        {
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold text-dark">@item.Product?.Sp_name</div>
                                    <small class="text-muted">ID: @item.Sp_item_id</small>
                                </td>
                                <td><code class="text-primary fw-bold">@item.SKU</code></td>
                                <td>
                                    <span class="badge rounded-pill @GetBrandBadgeClass(item.Product?.Brand?.Brand_name)">
                                        @item.Product?.Brand?.Brand_name
                                    </span>
                                </td>
                                <td class="text-center fw-bold">@item.StockQuantity</td>
                                <td class="text-center">
                                    @if (item.StockQuantity > 0)
                                    {
                                        <span class="badge bg-success-subtle text-success border border-success">Sẵn hàng</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger-subtle text-danger border border-danger">Hết hàng</span>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<ProductItem>? inventoryItems;
    private List<Brand>? Brands;
    
    private string SearchTerm = "";
    private int SelectedBrandId = 0;
    private int SelectedStatus = 0;

    // Khởi tạo: Load danh sách Hãng và dữ liệu tồn kho ban đầu
    protected override async Task OnInitializedAsync()
    {
        Brands = await DbContext.Brands.AsNoTracking().ToListAsync();
        await LoadData();
    }

    // Xử lý tìm kiếm khi người dùng nhập liệu
    private async Task HandleSearch(KeyboardEventArgs e) => await LoadData();

    // Lọc theo Hãng được chọn
    private async Task FilterByBrand(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int brandId))
        {
            SelectedBrandId = brandId;
            await LoadData();
        }
    }

    // Lọc theo trạng thái kho (Sẵn/Hết)
    private async Task FilterByStatus(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int status))
        {
            SelectedStatus = status;
            await LoadData();
        }
    }

    // Logic truy vấn Database chính
    private async Task LoadData()
    {
        // Khởi tạo query: Kết nối 3 bảng ProductItem -> Product -> Brand
        var query = DbContext.ProductItems
            .Include(pi => pi.Product)
            .ThenInclude(p => p.Brand)
            .AsNoTracking()
            .AsQueryable();

        // 1. Lọc theo từ khóa (SKU hoặc Tên SP)
        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            string keyword = SearchTerm.ToLower();
            query = query.Where(x => 
                (x.SKU != null && x.SKU.ToLower().Contains(keyword)) || 
                (x.Product != null && x.Product.Sp_name != null && x.Product.Sp_name.ToLower().Contains(keyword))
            );
        }

        // 2. Lọc theo Hãng (Sử dụng Khóa ngoại Brands_id)
        if (SelectedBrandId > 0)
        {
            query = query.Where(x => x.Product != null && x.Product.Brands_id == SelectedBrandId);
        }

        // 3. Lọc theo Trạng thái tồn kho
        if (SelectedStatus == 1) // Sẵn hàng
        {
            query = query.Where(x => x.StockQuantity > 0);
        }
        else if (SelectedStatus == 2) // Hết hàng
        {
            query = query.Where(x => x.StockQuantity <= 0);
        }

        // Thực thi truy vấn, sắp xếp theo ID mới nhất
        inventoryItems = await query
            .OrderByDescending(x => x.Sp_item_id)
            .Take(100)
            .ToListAsync();
    }

    // Trả về class CSS tương ứng với màu sắc từng thương hiệu
    private string GetBrandBadgeClass(string? brandName)
    {
        if (string.IsNullOrEmpty(brandName)) return "bg-light text-dark border";
        return brandName.ToLower() switch
        {
            "apple" => "bg-dark text-white",
            "samsung" => "bg-primary text-white",
            "xiaomi" => "bg-warning text-dark",
            "oppo" => "bg-success text-white",
            "sony" => "bg-dark text-white",
            "dell" => "bg-info text-white",
            "asus" => "bg-danger text-white",
            _ => "bg-light text-dark border"
        };
    }
}