@page "/staff/inventory"
@layout StaffLayout
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using QuanLyKho.Data
@using QuanLyKho.Models

@inject NavigationManager Nav
@inject AppDbContext DbContext

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h2 class="fw-bold mb-0 text-secondary">Tra cứu Tồn kho</h2>
            <p class="text-muted">Kiểm tra số lượng thực tế từ kho</p>
        </div>
        
        
    </div>

    @* --- THANH CÔNG CỤ: TÌM KIẾM & LỌC --- *@
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-2">
            <div class="row g-2">
                @* 1. Ô Tìm kiếm *@
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-0 text-muted ps-3">
                            <i class="bi bi-search"></i>
                        </span>
                        <input class="form-control border-0 shadow-none"
                               placeholder="Tìm theo tên SP, SKU..."
                               @bind="SearchTerm"
                               @bind:event="oninput" 
                               @onkeyup="HandleSearch" />
                    </div>
                </div>

                @* 2. Lọc theo Hãng *@
                <div class="col-md-3">
                    <select class="form-select border-0 bg-light fw-bold text-secondary" 
                            @onchange="FilterByBrand">
                        <option value="0">-- Tất cả Hãng --</option>
                        @if (Brands != null)
                        {
                            @foreach (var brand in Brands)
                            {
                                @* SỬA: Dùng Brand_Id và Brand_name khớp SQL *@
                                <option value="@brand.Brand_Id">@brand.Brand_name</option>
                            }
                        }
                    </select>
                </div>

                @* 3. Lọc theo Trạng thái *@
                <div class="col-md-3">
                    <select class="form-select border-0 bg-light fw-bold text-secondary" 
                            @onchange="FilterByStatus">
                        <option value="0">-- Tất cả Trạng thái --</option>
                        <option value="1" class="text-success">✅ Sẵn hàng</option>
                        <option value="2" class="text-danger">❌ Hết hàng</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    @* Bảng dữ liệu *@
    <div class="card border-0 shadow-sm overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr class="text-secondary small fw-bold text-uppercase">
                        <th class="ps-4 py-3">Sản phẩm</th>
                        <th>SKU</th>
                        <th>Hãng</th>
                        <th class="text-center">Tồn kho</th>
                        <th class="text-center">Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    @if (inventoryItems == null)
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status"></div>
                            </td>
                        </tr>
                    }
                    else if (inventoryItems.Count == 0)
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 opacity-50"></i>
                                <div class="mt-2">Không tìm thấy dữ liệu phù hợp</div>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in inventoryItems)
                        {
                            <tr>
                                @* Cột Tên SP *@
                                <td class="ps-4">
                                    <div class="fw-bold text-dark fs-6">
                                        @* SỬA: Dùng Sp_name *@
                                        @(item.Product?.Sp_name ?? "Sản phẩm lỗi")
                                    </div>
                                    <div class="d-flex gap-1 mt-1">
                                        @if(!string.IsNullOrEmpty(item.Storage))
                                        {
                                             <span class="badge bg-light text-dark border">@item.Storage</span>
                                        }
                                        @if(!string.IsNullOrEmpty(item.Color))
                                        {
                                            <span class="badge bg-light text-dark border">@item.Color</span>
                                        }
                                    </div>
                                </td>
                                
                                <td class="text-muted font-monospace">@item.SKU</td>
                                
                                <td>
                                    <span class="badge rounded-pill px-3 py-2 @GetBrandBadgeClass(item.Product?.Brand?.Brand_name)">
                                        @(item.Product?.Brand?.Brand_name ?? "-")
                                    </span>
                                </td>
                                
                                <td class="text-center">
                                    <span class="fw-bold fs-5 @(item.StockQuantity < 10 ? "text-danger" : "text-success")">
                                        @item.StockQuantity
                                    </span>
                                </td>
                                
                                <td class="text-center">
                                    @if (item.StockQuantity > 0)
                                    {
                                        <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle px-3">
                                            Sẵn hàng
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle px-3">
                                            Hết hàng
                                        </span>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<ProductItem>? inventoryItems;
    private List<Brand>? Brands;
    
    private string SearchTerm = "";
    private int SelectedBrandId = 0;
    private int SelectedStatus = 0;

    protected override async Task OnInitializedAsync()
    {
        Brands = await DbContext.Brands.AsNoTracking().ToListAsync();
        await LoadData();
    }

    private void GoToImport() => Nav.NavigateTo("/staff/import");
    private void GoToExport() => Nav.NavigateTo("/staff/export");

    private async Task HandleSearch(KeyboardEventArgs e) => await LoadData();

    private async Task FilterByBrand(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int brandId))
        {
            SelectedBrandId = brandId;
            await LoadData();
        }
    }

    private async Task FilterByStatus(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int status))
        {
            SelectedStatus = status;
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        // Join bảng: SP_item -> Sp -> Brands
        var query = DbContext.ProductItems
            .Include(pi => pi.Product)
            .ThenInclude(p => p.Brand)
            .AsNoTracking()
            .AsQueryable();

        // 1. Lọc theo từ khóa
        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            string keyword = SearchTerm.ToLower();
            // SỬA: Dùng Sp_name khớp SQL
            query = query.Where(x => 
                (x.SKU != null && x.SKU.ToLower().Contains(keyword)) || 
                (x.Product != null && x.Product.Sp_name != null && x.Product.Sp_name.ToLower().Contains(keyword))
            );
        }

        // 2. Lọc theo Hãng
        if (SelectedBrandId > 0)
        {
            // SỬA: Dùng Brands_id khớp SQL (Foreign Key trong bảng Sp)
            query = query.Where(x => x.Product != null && x.Product.Brands_id == SelectedBrandId);
        }

        // 3. Lọc theo Trạng thái
        if (SelectedStatus == 1) // Sẵn hàng
        {
            query = query.Where(x => x.StockQuantity > 0);
        }
        else if (SelectedStatus == 2) // Hết hàng
        {
            query = query.Where(x => x.StockQuantity <= 0);
        }

        // SỬA: Dùng Sp_item_id để sắp xếp
        inventoryItems = await query
            .OrderByDescending(x => x.Sp_item_id)
            .Take(100)
            .ToListAsync();
    }

    private string GetBrandBadgeClass(string? brandName)
    {
        if (string.IsNullOrEmpty(brandName)) return "bg-light text-dark border";
        return brandName.ToLower() switch
        {
            "apple" => "bg-dark text-white",
            "samsung" => "bg-primary text-white",
            "xiaomi" => "bg-warning text-dark",
            "oppo" => "bg-success text-white",
            "sony" => "bg-dark text-white",
            "dell" => "bg-info text-white", // Thêm màu cho Dell
            "asus" => "bg-danger text-white", // Thêm màu cho Asus
            _ => "bg-light text-dark border"
        };
    }
}