@page "/staff/history"
@layout Components.Layout.StaffLayout
@using QuanLyKho.Data
@rendermode InteractiveServer
@inject AppDbContext Db

<div class="container-fluid px-4">
    <h2 class="mt-4 mb-4 fw-bold text-secondary">Lịch sử Nhập / Xuất</h2>

    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-4">
                    <input class="form-control" placeholder="Tìm tên SP hoặc người thực hiện..." @bind="SearchTerm" @bind:event="oninput" />
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="TypeFilter">
                        <option value="">-- Tất cả loại --</option>
                        <option value="Nhập">Nhập kho</option>
                        <option value="Xuất">Xuất kho</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive bg-white shadow-sm rounded">
        <table class="table table-hover mb-0 align-middle">
            <thead class="bg-light">
                <tr>
                    <th>Thời gian</th>
                    <th>Loại</th>
                    <th>Sản phẩm</th>
                    <th>SKU</th>
                    <th class="text-center">Số lượng</th>
                    <th>Người thực hiện</th>
                    <th>Ghi chú</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var log in FilteredLogs)
                {
                    <tr>
                        <td>@log.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>
                            <span class="badge @(log.Type == "Nhập" ? "bg-primary" : "bg-danger")">
                                @log.Type
                            </span>
                        </td>
                        <td class="fw-bold">@log.ProductName</td>
                        <td class="text-muted small">@log.SKU</td>
                        <td class="text-center fw-bold">@log.Quantity</td>
                        <td>@log.StaffName</td>
                        <td class="text-muted small">@log.Note</td>
                    </tr>
                }
                @if (!FilteredLogs.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">Chưa có dữ liệu lịch sử.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private string SearchTerm = "";
    private string TypeFilter = "";
    private List<InventoryLog> logs = new();

    protected override void OnInitialized()
    {
        // Load lịch sử từ DB, sắp xếp mới nhất lên đầu
        logs = Db.InventoryLogs.OrderByDescending(x => x.CreatedAt).ToList();
    }

    private List<InventoryLog> FilteredLogs => logs
        .Where(l => (string.IsNullOrEmpty(SearchTerm) || l.ProductName.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) || l.StaffName.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) &&
                    (string.IsNullOrEmpty(TypeFilter) || l.Type == TypeFilter))
        .ToList();
}